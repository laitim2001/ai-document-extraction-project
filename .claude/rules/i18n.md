---
paths: src/**/*.{ts,tsx}, messages/**/*.json
---

# 國際化（i18n）開發規範

> **核心框架**: next-intl
> **建立版本**: Epic 17 - i18n Implementation
> **最後更新**: 2026-01-18

---

## 架構概覽

```
┌─────────────────────────────────────────────────────────────────┐
│ URL 路由: /[locale]/(dashboard)/...                             │
│ 支援語言: en, zh-TW, zh-CN                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 訊息文件: messages/{locale}/*.json                              │
│ 格式工具: src/lib/i18n-{date,number,currency}.ts                │
│ 驗證工具: src/lib/i18n-zod.ts + src/hooks/use-localized-zod.ts │
└─────────────────────────────────────────────────────────────────┘
```

## 支援語言

| 代碼 | 語言 | 說明 |
|------|------|------|
| `en` | English | 預設語言（fallback） |
| `zh-TW` | 繁體中文 | 主要目標用戶語言 |
| `zh-CN` | 简体中文 | 擴展支援 |

---

## 目錄結構

```
src/
├── i18n/
│   ├── config.ts        # 語言配置常數
│   ├── routing.ts       # next-intl 路由配置
│   └── request.ts       # Server-side locale 請求
├── lib/
│   ├── i18n-date.ts     # 日期格式化工具
│   ├── i18n-number.ts   # 數字格式化工具
│   ├── i18n-currency.ts # 貨幣格式化工具
│   └── i18n-zod.ts      # Zod 驗證國際化
├── hooks/
│   ├── use-locale-preference.ts  # 語言偏好管理
│   ├── use-localized-date.ts     # 日期格式 Hook
│   ├── use-localized-format.ts   # 格式化 Hook
│   └── use-localized-zod.ts      # Zod 驗證 Hook
└── components/
    └── features/locale/
        └── LocaleSwitcher.tsx    # 語言切換組件

messages/
├── en/
│   ├── common.json      # 通用詞彙
│   ├── navigation.json  # 導航選單
│   ├── validation.json  # 驗證訊息
│   ├── errors.json      # 錯誤訊息
│   └── [feature].json   # 功能模組
├── zh-TW/
│   └── (同上)
└── zh-CN/
    └── (同上)
```

---

## 訊息文件規範

### 文件命名

| 文件名 | 用途 | 範例內容 |
|--------|------|----------|
| `common.json` | 通用詞彙（按鈕、狀態等） | actions, status, form |
| `navigation.json` | 導航選單、側邊欄 | sidebar, topbar, breadcrumb |
| `validation.json` | 表單驗證訊息 | required, minLength, email |
| `errors.json` | API/系統錯誤訊息 | notFound, unauthorized |
| `[feature].json` | 功能模組專用 | dashboard, invoices, rules |

### JSON 結構規範

```json
{
  "section": {
    "title": "區塊標題",
    "description": "區塊描述",
    "fields": {
      "name": "名稱",
      "email": "電郵"
    }
  },
  "actions": {
    "save": "儲存",
    "cancel": "取消"
  }
}
```

### 動態參數

```json
{
  "greeting": "你好，{name}！",
  "items": "共 {count} 項",
  "pagination": {
    "showing": "顯示 {start} - {end}，共 {total} 項"
  }
}
```

### 複數形式

```json
{
  "items": {
    "zero": "沒有項目",
    "one": "1 個項目",
    "other": "{count} 個項目"
  }
}
```

---

## 組件使用規範

### Client Components

```typescript
'use client';

import { useTranslations, useLocale } from 'next-intl';

export function MyComponent() {
  // 取得翻譯函數
  const t = useTranslations('namespace');
  const tCommon = useTranslations('common');

  // 取得當前語言
  const locale = useLocale();

  return (
    <div>
      <h1>{t('title')}</h1>
      <p>{t('description', { count: 5 })}</p>
      <button>{tCommon('actions.save')}</button>
    </div>
  );
}
```

### Server Components

```typescript
import { getTranslations } from 'next-intl/server';

export default async function Page() {
  const t = await getTranslations('namespace');

  return (
    <div>
      <h1>{t('title')}</h1>
    </div>
  );
}
```

### 路由與導航

```typescript
// ✅ 使用 i18n-aware 的 Link 和 Router
import { Link, useRouter, usePathname } from '@/i18n/routing';

function Navigation() {
  const router = useRouter();
  const pathname = usePathname();

  return (
    <Link href="/dashboard">Dashboard</Link>
  );
}

// ❌ 不要使用 next/link 和 next/navigation（除非有特殊需求）
import Link from 'next/link';  // 避免
```

---

## 格式化工具使用

### 日期格式化

```typescript
import { useLocale } from 'next-intl';
import { formatShortDate, formatDateTime, formatRelativeTime } from '@/lib/i18n-date';

function DateDisplay({ date }: { date: Date }) {
  const locale = useLocale();

  return (
    <>
      <span>{formatShortDate(date, locale)}</span>      {/* 2026/01/18 */}
      <span>{formatDateTime(date, locale)}</span>       {/* 2026年1月18日 14:30 */}
      <span>{formatRelativeTime(date, locale)}</span>   {/* 2 小時前 */}
    </>
  );
}
```

### 數字格式化

```typescript
import { formatNumber, formatPercent, formatCompact } from '@/lib/i18n-number';

formatNumber(1234567, 'zh-TW');     // "1,234,567"
formatPercent(95.5, 'zh-TW');       // "95.5%"
formatCompact(1234567, 'en');       // "1.2M"
```

### 貨幣格式化

```typescript
import { formatCurrency } from '@/lib/i18n-currency';

formatCurrency(1234.56, 'USD', 'en');      // "$1,234.56"
formatCurrency(1234.56, 'TWD', 'zh-TW');   // "NT$1,235"
```

---

## 表單驗證國際化

### 使用 useLocalizedZod Hook

```typescript
'use client';

import { useLocalizedZod, getFieldLabels } from '@/hooks/use-localized-zod';
import { useLocale } from 'next-intl';

function MyForm() {
  const locale = useLocale();
  const { errorMap } = useLocalizedZod(getFieldLabels(locale));

  // errorMap 可傳入 zodResolver
  const form = useForm({
    resolver: zodResolver(schema, { errorMap }),
  });
}
```

### 驗證訊息翻譯

驗證訊息存放在 `messages/{locale}/validation.json`：

```json
{
  "required": "此欄位為必填",
  "string": {
    "min": "{field}至少需要 {min} 個字元",
    "max": "{field}最多 {max} 個字元",
    "email": "請輸入有效的電郵地址"
  }
}
```

---

## 新增翻譯的標準流程

### Step 1: 確定命名空間

```
新功能屬於哪個模組？
├─ 通用詞彙 → common.json
├─ 導航相關 → navigation.json
├─ 驗證訊息 → validation.json
├─ 錯誤訊息 → errors.json
└─ 功能專用 → [feature].json
```

### Step 2: 同步更新所有語言文件

```bash
# 必須同時更新：
messages/en/[namespace].json
messages/zh-TW/[namespace].json
messages/zh-CN/[namespace].json
```

### Step 3: 使用一致的 Key 命名

```json
// ✅ 好的命名
{
  "pageTitle": "頁面標題",
  "form": {
    "fieldName": "欄位名稱",
    "submitButton": "提交"
  }
}

// ❌ 不好的命名
{
  "title1": "標題",
  "btn": "按鈕"
}
```

---

## 常見模式

### 條件翻譯

```typescript
const statusMessages = {
  pending: t('status.pending'),
  completed: t('status.completed'),
  failed: t('status.failed'),
};

return <Badge>{statusMessages[status]}</Badge>;
```

### 帶 HTML 的翻譯

```typescript
// 在 JSON 中
{ "richText": "請閱讀<link>使用條款</link>" }

// 在組件中
{t.rich('richText', {
  link: (chunks) => <Link href="/terms">{chunks}</Link>
})}
```

### 日期範圍格式化

```typescript
import { formatDateRange } from '@/lib/i18n-date';

formatDateRange(startDate, endDate, locale);
// "2026年1月1日 - 2026年1月31日"
```

---

## 注意事項

### 必須遵守

- ✅ 所有使用者可見文字必須使用翻譯系統
- ✅ 新增翻譯時必須同步更新所有語言文件
- ✅ 使用 `@/i18n/routing` 的 Link 和 Router
- ✅ 日期、數字、貨幣使用專用格式化工具
- ✅ 表單驗證訊息使用 `useLocalizedZod`

### 禁止事項

- ❌ 不要硬編碼使用者可見文字
- ❌ 不要只更新部分語言文件
- ❌ 不要使用 `next/link` 取代 `@/i18n/routing` 的 Link
- ❌ 不要自行拼接日期/數字格式（使用工具函數）
- ❌ 不要在翻譯 Key 中使用動態值

### 例外情況

以下內容**不需要**翻譯：
- 技術代碼、ID、常數名稱
- 公司名稱、品牌名稱（除非有官方翻譯）
- 外部 API 返回的原始錯誤訊息（但應包裝為友善訊息）
- 開發者專用的日誌訊息

---

## 相關文件

- [src/i18n/config.ts](../../src/i18n/config.ts) - 語言配置
- [src/i18n/routing.ts](../../src/i18n/routing.ts) - 路由配置
- [src/lib/i18n-date.ts](../../src/lib/i18n-date.ts) - 日期格式化
- [src/lib/i18n-number.ts](../../src/lib/i18n-number.ts) - 數字格式化
- [src/hooks/use-localized-zod.ts](../../src/hooks/use-localized-zod.ts) - 驗證國際化

---

## 技術細節

### 語言偵測優先級

```
1. URL 路徑中的 locale（/zh-TW/dashboard）
2. 使用者資料庫偏好（已登入）
3. LocalStorage 偏好
4. 瀏覽器 Accept-Language
5. 預設語言（en）
```

### 語言偏好持久化

```typescript
import { useLocalePreference } from '@/hooks/use-locale-preference';

const { setLocalePreference } = useLocalePreference();

// 會同時保存到 LocalStorage 和資料庫（如已登入）
await setLocalePreference('zh-TW');
```

---

**維護者**: Development Team
**建立日期**: 2026-01-18
**版本**: 1.0.0
