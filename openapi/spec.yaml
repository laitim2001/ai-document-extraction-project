openapi: 3.0.3
info:
  title: Invoice Extraction API
  description: |
    AI-powered invoice document extraction and classification API.

    ## Authentication
    All API requests require Bearer token authentication.
    Include your API key in the Authorization header:
    ```
    Authorization: Bearer your-api-key-here
    ```

    ## Rate Limiting
    - Default: 60 requests per minute
    - Burst: Up to 10 concurrent requests
    - Rate limit headers included in all responses

    ## Webhook Signatures
    Webhook payloads are signed using HMAC-SHA256.
    Verify the `X-Webhook-Signature` header to ensure authenticity.
  version: 1.0.0
  contact:
    name: API Support
    email: api-support@example.com
  license:
    name: Proprietary
    url: https://example.com/license

servers:
  - url: https://api.example.com/api/v1
    description: Production server
  - url: https://staging-api.example.com/api/v1
    description: Staging server
  - url: http://localhost:3000/api/v1
    description: Development server

tags:
  - name: Invoices
    description: Invoice submission and processing
  - name: Tasks
    description: Task status and management
  - name: Webhooks
    description: Webhook configuration and delivery

security:
  - BearerAuth: []

paths:
  /invoices:
    post:
      tags:
        - Invoices
      summary: Submit invoice for processing
      description: |
        Upload an invoice document for AI-powered extraction.
        Supports PDF, JPEG, and PNG formats.
        Maximum file size: 10MB.
      operationId: submitInvoice
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/InvoiceSubmissionRequest'
      responses:
        '202':
          description: Invoice accepted for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceSubmissionResponse'
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /invoices/{taskId}:
    get:
      tags:
        - Invoices
      summary: Get invoice extraction result
      description: |
        Retrieve the extraction results for a previously submitted invoice.
        Results are available once the task status is COMPLETED.
      operationId: getInvoiceResult
      parameters:
        - $ref: '#/components/parameters/TaskIdPath'
      responses:
        '200':
          description: Invoice extraction result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceResultResponse'
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /tasks/{taskId}/status:
    get:
      tags:
        - Tasks
      summary: Get task status
      description: |
        Check the processing status of a submitted invoice task.
        Poll this endpoint to track progress.
      operationId: getTaskStatus
      parameters:
        - $ref: '#/components/parameters/TaskIdPath'
      responses:
        '200':
          description: Task status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskStatusResponse'
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /webhooks:
    get:
      tags:
        - Webhooks
      summary: List webhooks
      description: Get all registered webhooks for the authenticated client
      operationId: listWebhooks
      parameters:
        - $ref: '#/components/parameters/PageQuery'
        - $ref: '#/components/parameters/LimitQuery'
      responses:
        '200':
          description: List of webhooks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      tags:
        - Webhooks
      summary: Register webhook
      description: |
        Register a new webhook endpoint to receive task completion notifications.
        The webhook URL must be HTTPS and respond with 2xx status within 30 seconds.
      operationId: registerWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookRegistrationRequest'
      responses:
        '201':
          description: Webhook registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookRegistrationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /webhooks/{webhookId}:
    get:
      tags:
        - Webhooks
      summary: Get webhook details
      description: Retrieve details of a specific webhook
      operationId: getWebhook
      parameters:
        - $ref: '#/components/parameters/WebhookIdPath'
      responses:
        '200':
          description: Webhook details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'
    patch:
      tags:
        - Webhooks
      summary: Update webhook
      description: Update an existing webhook configuration
      operationId: updateWebhook
      parameters:
        - $ref: '#/components/parameters/WebhookIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookUpdateRequest'
      responses:
        '200':
          description: Webhook updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      tags:
        - Webhooks
      summary: Delete webhook
      description: Remove a registered webhook
      operationId: deleteWebhook
      parameters:
        - $ref: '#/components/parameters/WebhookIdPath'
      responses:
        '204':
          description: Webhook deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /webhooks/{webhookId}/deliveries:
    get:
      tags:
        - Webhooks
      summary: List webhook deliveries
      description: Get delivery history for a specific webhook
      operationId: listWebhookDeliveries
      parameters:
        - $ref: '#/components/parameters/WebhookIdPath'
        - $ref: '#/components/parameters/PageQuery'
        - $ref: '#/components/parameters/LimitQuery'
      responses:
        '200':
          description: List of webhook deliveries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookDeliveryListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /webhooks/{webhookId}/deliveries/{deliveryId}/retry:
    post:
      tags:
        - Webhooks
      summary: Retry webhook delivery
      description: Manually retry a failed webhook delivery
      operationId: retryWebhookDelivery
      parameters:
        - $ref: '#/components/parameters/WebhookIdPath'
        - $ref: '#/components/parameters/DeliveryIdPath'
      responses:
        '202':
          description: Retry initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookRetryResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: API Key
      description: |
        API Key authentication using Bearer token.
        Obtain your API key from the developer portal.

  parameters:
    TaskIdPath:
      name: taskId
      in: path
      required: true
      description: Unique task identifier
      schema:
        type: string
        format: uuid
        example: '550e8400-e29b-41d4-a716-446655440000'

    WebhookIdPath:
      name: webhookId
      in: path
      required: true
      description: Unique webhook identifier
      schema:
        type: string
        format: uuid
        example: '7c9e6679-7425-40de-944b-e07fc1f90ae7'

    DeliveryIdPath:
      name: deliveryId
      in: path
      required: true
      description: Unique delivery identifier
      schema:
        type: string
        format: uuid
        example: '9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d'

    PageQuery:
      name: page
      in: query
      description: Page number for pagination
      schema:
        type: integer
        minimum: 1
        default: 1
        example: 1

    LimitQuery:
      name: limit
      in: query
      description: Number of items per page
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
        example: 20

  headers:
    X-RateLimit-Limit:
      description: The number of allowed requests in the current period
      schema:
        type: integer
        example: 60

    X-RateLimit-Remaining:
      description: The number of remaining requests in the current period
      schema:
        type: integer
        example: 59

    X-RateLimit-Reset:
      description: The time at which the current rate limit window resets (Unix timestamp)
      schema:
        type: integer
        example: 1640995200

  schemas:
    # Request Schemas
    InvoiceSubmissionRequest:
      type: object
      required:
        - file
        - forwarderId
      properties:
        file:
          type: string
          format: binary
          description: Invoice document file (PDF, JPEG, PNG)
        forwarderId:
          type: string
          format: uuid
          description: Forwarder identifier for mapping rules
          example: '123e4567-e89b-12d3-a456-426614174000'
        callbackUrl:
          type: string
          format: uri
          description: Optional callback URL for completion notification
          example: 'https://your-server.com/webhook'
        priority:
          type: string
          enum:
            - LOW
            - NORMAL
            - HIGH
          default: NORMAL
          description: Processing priority
        metadata:
          type: object
          additionalProperties: true
          description: Custom metadata to include with the task
          example:
            orderId: 'ORD-12345'
            department: 'Finance'

    WebhookRegistrationRequest:
      type: object
      required:
        - url
        - events
      properties:
        url:
          type: string
          format: uri
          description: HTTPS endpoint to receive webhook events
          example: 'https://your-server.com/webhooks/invoice'
        events:
          type: array
          items:
            type: string
            enum:
              - task.completed
              - task.failed
              - task.cancelled
          description: Events to subscribe to
          example:
            - task.completed
            - task.failed
        secret:
          type: string
          minLength: 32
          maxLength: 256
          description: Secret for HMAC signature verification (auto-generated if not provided)
        active:
          type: boolean
          default: true
          description: Whether the webhook is active

    WebhookUpdateRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: Updated HTTPS endpoint
        events:
          type: array
          items:
            type: string
            enum:
              - task.completed
              - task.failed
              - task.cancelled
          description: Updated event subscriptions
        active:
          type: boolean
          description: Whether the webhook is active

    # Response Schemas
    InvoiceSubmissionResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          required:
            - taskId
            - status
            - createdAt
          properties:
            taskId:
              type: string
              format: uuid
              description: Unique identifier for tracking the task
              example: '550e8400-e29b-41d4-a716-446655440000'
            status:
              type: string
              enum:
                - PENDING
                - PROCESSING
                - COMPLETED
                - FAILED
                - CANCELLED
              example: PENDING
            createdAt:
              type: string
              format: date-time
              example: '2024-01-15T10:30:00Z'
            estimatedCompletionTime:
              type: string
              format: date-time
              description: Estimated completion time
              example: '2024-01-15T10:35:00Z'

    InvoiceResultResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          required:
            - taskId
            - status
            - result
          properties:
            taskId:
              type: string
              format: uuid
              example: '550e8400-e29b-41d4-a716-446655440000'
            status:
              type: string
              enum:
                - COMPLETED
              example: COMPLETED
            result:
              $ref: '#/components/schemas/ExtractionResult'
            completedAt:
              type: string
              format: date-time
              example: '2024-01-15T10:32:15Z'
            processingDuration:
              type: integer
              description: Processing time in milliseconds
              example: 2150

    ExtractionResult:
      type: object
      required:
        - invoiceNumber
        - vendorName
        - totalAmount
        - currency
        - confidence
      properties:
        invoiceNumber:
          type: string
          description: Extracted invoice number
          example: 'INV-2024-00123'
        vendorName:
          type: string
          description: Vendor/supplier name
          example: 'ABC Logistics Co., Ltd.'
        invoiceDate:
          type: string
          format: date
          description: Invoice date
          example: '2024-01-10'
        dueDate:
          type: string
          format: date
          description: Payment due date
          example: '2024-02-10'
        totalAmount:
          type: number
          format: decimal
          description: Total invoice amount
          example: 15250.00
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
          description: ISO 4217 currency code
          example: 'USD'
        lineItems:
          type: array
          items:
            $ref: '#/components/schemas/LineItem'
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: Overall extraction confidence score
          example: 92.5
        rawText:
          type: string
          description: Raw OCR text (if requested)

    LineItem:
      type: object
      required:
        - description
        - amount
      properties:
        description:
          type: string
          description: Line item description
          example: 'Ocean Freight - Shanghai to Los Angeles'
        quantity:
          type: number
          description: Quantity
          example: 1
        unitPrice:
          type: number
          format: decimal
          description: Price per unit
          example: 12500.00
        amount:
          type: number
          format: decimal
          description: Total line item amount
          example: 12500.00
        chargeCode:
          type: string
          description: Mapped charge code
          example: 'OCEAN_FREIGHT'
        confidenceScore:
          type: number
          format: float
          minimum: 0
          maximum: 100
          description: Line item extraction confidence
          example: 95.0

    TaskStatusResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          required:
            - taskId
            - status
          properties:
            taskId:
              type: string
              format: uuid
              example: '550e8400-e29b-41d4-a716-446655440000'
            status:
              type: string
              enum:
                - PENDING
                - PROCESSING
                - COMPLETED
                - FAILED
                - CANCELLED
              example: PROCESSING
            progress:
              type: integer
              minimum: 0
              maximum: 100
              description: Processing progress percentage
              example: 45
            currentStep:
              type: string
              description: Current processing step
              example: 'Extracting line items'
            createdAt:
              type: string
              format: date-time
              example: '2024-01-15T10:30:00Z'
            updatedAt:
              type: string
              format: date-time
              example: '2024-01-15T10:31:00Z'
            error:
              $ref: '#/components/schemas/TaskError'

    TaskError:
      type: object
      properties:
        code:
          type: string
          description: Error code
          example: 'OCR_FAILED'
        message:
          type: string
          description: Human-readable error message
          example: 'Failed to extract text from document'
        details:
          type: object
          additionalProperties: true
          description: Additional error details

    WebhookResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/Webhook'

    WebhookRegistrationResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          example: true
        data:
          allOf:
            - $ref: '#/components/schemas/Webhook'
            - type: object
              properties:
                secret:
                  type: string
                  description: Webhook secret (only shown once)
                  example: 'whsec_abc123...'

    Webhook:
      type: object
      required:
        - id
        - url
        - events
        - active
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          example: '7c9e6679-7425-40de-944b-e07fc1f90ae7'
        url:
          type: string
          format: uri
          example: 'https://your-server.com/webhooks/invoice'
        events:
          type: array
          items:
            type: string
          example:
            - task.completed
            - task.failed
        active:
          type: boolean
          example: true
        createdAt:
          type: string
          format: date-time
          example: '2024-01-15T10:30:00Z'
        updatedAt:
          type: string
          format: date-time
          example: '2024-01-15T10:30:00Z'

    WebhookListResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/Webhook'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    WebhookDeliveryListResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/WebhookDelivery'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    WebhookDelivery:
      type: object
      required:
        - id
        - webhookId
        - event
        - status
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          example: '9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d'
        webhookId:
          type: string
          format: uuid
          example: '7c9e6679-7425-40de-944b-e07fc1f90ae7'
        event:
          type: string
          example: 'task.completed'
        status:
          type: string
          enum:
            - PENDING
            - DELIVERED
            - FAILED
          example: DELIVERED
        httpStatus:
          type: integer
          description: HTTP status code from the endpoint
          example: 200
        attemptCount:
          type: integer
          description: Number of delivery attempts
          example: 1
        lastAttemptAt:
          type: string
          format: date-time
          example: '2024-01-15T10:32:20Z'
        nextRetryAt:
          type: string
          format: date-time
          description: Next retry time (if failed)
        createdAt:
          type: string
          format: date-time
          example: '2024-01-15T10:32:15Z'

    WebhookRetryResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            deliveryId:
              type: string
              format: uuid
              example: '9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d'
            status:
              type: string
              example: PENDING
            scheduledAt:
              type: string
              format: date-time
              example: '2024-01-15T10:35:00Z'

    PaginationMeta:
      type: object
      properties:
        pagination:
          type: object
          properties:
            page:
              type: integer
              example: 1
            limit:
              type: integer
              example: 20
            total:
              type: integer
              example: 45
            totalPages:
              type: integer
              example: 3

    # Error Schemas (RFC 7807)
    ProblemDetails:
      type: object
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
          description: A URI reference that identifies the problem type
          example: 'https://api.example.com/errors/validation'
        title:
          type: string
          description: A short, human-readable summary of the problem type
          example: 'Validation Error'
        status:
          type: integer
          description: The HTTP status code
          example: 400
        detail:
          type: string
          description: A human-readable explanation specific to this occurrence
          example: 'The forwarderId field is required'
        instance:
          type: string
          format: uri
          description: A URI reference that identifies the specific occurrence
          example: '/api/v1/invoices'
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Field-level validation errors
          example:
            forwarderId:
              - 'This field is required'
            file:
              - 'File size exceeds 10MB limit'

  responses:
    BadRequest:
      description: Bad request - validation error or malformed request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: 'https://api.example.com/errors/validation'
            title: 'Validation Error'
            status: 400
            detail: 'One or more fields failed validation'
            instance: '/api/v1/invoices'
            errors:
              forwarderId:
                - 'Invalid UUID format'

    Unauthorized:
      description: Authentication required or invalid credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: 'https://api.example.com/errors/unauthorized'
            title: 'Unauthorized'
            status: 401
            detail: 'Invalid or expired API key'
            instance: '/api/v1/invoices'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: 'https://api.example.com/errors/not-found'
            title: 'Not Found'
            status: 404
            detail: 'Task with ID 550e8400-e29b-41d4-a716-446655440000 not found'
            instance: '/api/v1/invoices/550e8400-e29b-41d4-a716-446655440000'

    PayloadTooLarge:
      description: Request payload too large
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: 'https://api.example.com/errors/payload-too-large'
            title: 'Payload Too Large'
            status: 413
            detail: 'File size exceeds the maximum allowed size of 10MB'
            instance: '/api/v1/invoices'

    TooManyRequests:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          $ref: '#/components/headers/X-RateLimit-Limit'
        X-RateLimit-Remaining:
          $ref: '#/components/headers/X-RateLimit-Remaining'
        X-RateLimit-Reset:
          $ref: '#/components/headers/X-RateLimit-Reset'
        Retry-After:
          description: Seconds to wait before retrying
          schema:
            type: integer
            example: 60
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: 'https://api.example.com/errors/rate-limit'
            title: 'Too Many Requests'
            status: 429
            detail: 'Rate limit exceeded. Please retry after 60 seconds.'
            instance: '/api/v1/invoices'

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
          example:
            type: 'https://api.example.com/errors/internal'
            title: 'Internal Server Error'
            status: 500
            detail: 'An unexpected error occurred. Please try again later.'
            instance: '/api/v1/invoices'
