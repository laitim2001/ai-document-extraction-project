# Epic 12: 系統管理與監控

**目標**：系統管理員可以監控系統健康狀態、追蹤效能指標、配置告警、管理系統配置和備份

**FRs 覆蓋**：FR59, FR60, FR61, FR62, FR63

---

## Story 12.1: 系統健康監控儀表板

**As a** 系統管理員,
**I want** 查看系統整體健康狀態儀表板,
**So that** 我可以即時了解系統運行情況並快速發現問題。

**Acceptance Criteria:**

**Given** 系統管理員已登入
**When** 導航至「系統監控」頁面
**Then** 顯示系統健康儀表板，包含：
- 整體健康狀態指示器（正常/警告/異常）
- 各服務狀態卡片（Web 應用、AI 服務、數據庫、儲存服務）
- 最近 24 小時的可用性百分比
- 當前活躍用戶數

**Given** 健康儀表板
**When** 某個服務狀態異常
**Then** 對應卡片顯示紅色警示
**And** 顯示異常開始時間
**And** 顯示簡要錯誤描述

**Given** 健康儀表板
**When** 服務狀態變化
**Then** 儀表板自動更新（每 30 秒刷新）
**And** 狀態變化時顯示通知

**Given** 服務狀態卡片
**When** 點擊某個服務
**Then** 展開顯示詳細資訊：
- 回應時間趨勢圖
- 錯誤率統計
- 最近的錯誤日誌

**技術備註：**
- 實現各服務的健康檢查端點
- 使用 WebSocket 實現即時更新
- 創建 `ServiceHealthCheck` 資料表記錄歷史

**FR 覆蓋**：FR59

---

## Story 12.2: 效能指標追蹤

**As a** 系統管理員,
**I want** 追蹤系統效能指標,
**So that** 我可以識別效能瓶頸並進行優化。

**Acceptance Criteria:**

**Given** 系統管理員在效能監控頁面
**When** 查看效能指標
**Then** 顯示以下指標的即時數據和趨勢圖：
- API 回應時間（P50, P95, P99）
- 數據庫查詢時間
- AI 服務處理時間
- 文件上傳/下載速度
- 記憶體使用率
- CPU 使用率

**Given** 效能指標
**When** 選擇時間範圍
**Then** 支援：最近 1 小時、6 小時、24 小時、7 天、30 天

**Given** 效能指標
**When** 某項指標超過閾值
**Then** 在圖表上標記警告區域
**And** 顯示超標時間點

**Given** 效能監控頁面
**When** 需要深入分析
**Then** 可以查看：
- 最慢的 API 端點列表
- 最慢的數據庫查詢列表
- 資源消耗最高的操作

**Given** 效能數據
**When** 需要匯出
**Then** 支援匯出為 CSV 格式
**And** 包含完整的時間序列數據

**技術備註：**
- 收集 API 回應時間中間件
- 使用時間序列數據結構儲存指標
- 配置效能閾值參數

**FR 覆蓋**：FR60

---

## Story 12.3: 錯誤告警配置

**As a** 系統管理員,
**I want** 配置錯誤告警規則,
**So that** 當系統出現問題時能及時收到通知。

**Acceptance Criteria:**

**Given** 系統管理員在告警配置頁面
**When** 創建新告警規則
**Then** 可以設定：
- 告警名稱和描述
- 觸發條件（指標類型、閾值、持續時間）
- 告警級別（資訊/警告/嚴重/緊急）
- 通知管道（Email/Microsoft Teams）
- 通知對象（用戶或群組）

**Given** 告警規則
**When** 配置觸發條件
**Then** 支援以下條件類型：
- 服務不可用持續 X 分鐘
- 錯誤率超過 X%
- 回應時間超過 X 毫秒
- 隊列積壓超過 X 筆
- 儲存空間低於 X%

**Given** 告警觸發
**When** 條件滿足
**Then** 系統發送通知：
- 包含告警名稱、級別、觸發時間
- 包含相關指標數據
- 包含快速連結至監控頁面

**Given** 告警已觸發
**When** 條件恢復正常
**Then** 系統發送恢復通知
**And** 記錄告警持續時間

**Given** 告警歷史
**When** 查看告警記錄
**Then** 顯示所有歷史告警：
- 觸發時間、恢復時間、持續時間
- 告警級別和類型
- 處理狀態（未處理/已確認/已解決）

**技術備註：**
- 創建 `AlertRule` 和 `AlertHistory` 資料表
- 實現告警評估排程任務
- 整合 Email 和 Teams Webhook 通知

**FR 覆蓋**：FR61

---

## Story 12.4: 系統配置管理

**As a** 系統管理員,
**I want** 管理系統配置參數,
**So that** 我可以調整系統行為而不需要重新部署。

**Acceptance Criteria:**

**Given** 系統管理員在配置管理頁面
**When** 查看系統配置
**Then** 顯示可配置參數分類列表：
- 處理參數（信心度閾值、自動通過閾值）
- 整合設定（AI 服務參數、n8n 連線）
- 安全設定（Session 超時、密碼策略）
- 通知設定（Email SMTP、Teams Webhook）

**Given** 配置參數
**When** 編輯某個參數
**Then** 顯示：
- 參數名稱和描述
- 當前值和預設值
- 允許的值範圍或選項
- 變更影響說明

**Given** 修改配置
**When** 點擊「儲存」
**Then** 系統驗證配置值
**And** 如果驗證失敗顯示錯誤訊息
**And** 如果驗證成功則：
  - 儲存新配置
  - 記錄變更至審計日誌
  - 立即生效或提示需要重啟

**Given** 敏感配置（如密鑰）
**When** 顯示或編輯
**Then** 值以遮罩方式顯示
**And** 變更需要二次確認

**Given** 配置變更歷史
**When** 需要查看或回滾
**Then** 顯示變更歷史：
- 變更時間、變更人
- 變更前後的值
- 提供「回滾」按鈕

**技術備註：**
- 創建 `SystemConfig` 資料表（key, value, type, description, updatedAt, updatedBy）
- 實現配置熱載入機制
- 敏感配置值加密儲存

**FR 覆蓋**：FR62

---

## Story 12.5: 數據備份管理

**As a** 系統管理員,
**I want** 管理系統數據備份,
**So that** 確保數據安全並可在需要時恢復。

**Acceptance Criteria:**

**Given** 系統管理員在備份管理頁面
**When** 查看備份狀態
**Then** 顯示：
- 自動備份狀態（啟用/停用）
- 最近一次備份時間
- 備份保留策略
- 儲存空間使用情況

**Given** 備份列表
**When** 查看歷史備份
**Then** 顯示所有備份記錄：
- 備份時間
- 備份類型（完整/增量）
- 備份大小
- 備份狀態（成功/失敗）

**Given** 備份管理頁面
**When** 點擊「立即備份」
**Then** 系統執行手動備份：
- 顯示備份進度
- 完成後顯示結果（成功/失敗）
- 備份包含：數據庫、上傳文件、系統配置

**Given** 備份配置
**When** 設定備份排程
**Then** 可以配置：
- 備份頻率（每日/每週）
- 備份時間（選擇低峰時段）
- 保留期限（保留最近 N 個備份）
- 備份類型（完整/增量）

**技術備註：**
- 使用 Azure Backup 服務
- 數據庫使用 PostgreSQL pg_dump
- 文件使用 Azure Blob 快照

**FR 覆蓋**：FR63

---

## Story 12.6: 數據恢復功能

**As a** 系統管理員,
**I want** 從備份恢復系統數據,
**So that** 在發生數據損失時可以快速恢復。

**Acceptance Criteria:**

**Given** 系統管理員在備份管理頁面
**When** 需要恢復數據
**Then** 選擇備份點後顯示恢復選項：
- 完整恢復（替換所有數據）
- 部分恢復（選擇特定表或文件）
- 恢復至新環境（不影響現有數據）

**Given** 選擇恢復
**When** 開始恢復操作
**Then** 系統要求：
- 二次確認（輸入確認文字）
- 記錄恢復操作至審計日誌
- 顯示恢復進度

**Given** 恢復進行中
**When** 查看進度
**Then** 顯示：
- 當前步驟（數據庫/文件/配置）
- 預估剩餘時間
- 已恢復的數據量

**Given** 恢復完成
**When** 操作結束
**Then** 系統：
- 顯示恢復結果報告
- 列出恢復的數據統計
- 提供數據完整性驗證結果

**Given** 恢復測試
**When** 需要驗證備份可用性
**Then** 支援「恢復演練」功能：
- 恢復至隔離環境
- 不影響生產數據
- 生成演練報告

**技術備註：**
- 實現恢復前的自動備份（防止覆蓋）
- 恢復操作需要在維護時間窗口執行
- 記錄詳細的恢復日誌

**FR 覆蓋**：FR63

---

## Story 12.7: 系統日誌查詢

**As a** 系統管理員,
**I want** 查詢和分析系統日誌,
**So that** 我可以診斷問題和追蹤系統行為。

**Acceptance Criteria:**

**Given** 系統管理員在日誌查詢頁面
**When** 搜尋日誌
**Then** 支援以下篩選條件：
- 時間範圍
- 日誌級別（Debug/Info/Warning/Error/Critical）
- 服務來源（Web/AI/Database/n8n）
- 關鍵字搜尋
- 用戶 ID 或請求 ID

**Given** 日誌查詢結果
**When** 查看日誌列表
**Then** 顯示：
- 時間戳
- 日誌級別（顏色編碼）
- 服務來源
- 訊息摘要
**And** 點擊可展開完整內容

**Given** 某筆日誌
**When** 查看詳情
**Then** 顯示：
- 完整日誌訊息
- 堆疊追蹤（如有）
- 關聯的請求 ID
- 相關的用戶資訊
- 連結到相關的其他日誌

**Given** 日誌查詢
**When** 結果量大
**Then** 支援分頁（每頁 100 筆）
**And** 支援匯出（最多 10,000 筆）

**Given** 即時日誌
**When** 需要監控
**Then** 提供「即時日誌串流」功能
**And** 可以暫停/繼續串流

**技術備註：**
- 使用結構化日誌格式（JSON）
- 實現請求追蹤 ID（correlation ID）
- 日誌保留期限：30 天（可配置）

**FR 覆蓋**：FR59, FR60 (整合監控)
