# Epic 8: 審計追溯與合規

**目標**：審計人員可以查詢處理記錄，追溯至原始文件，匯出合規報告

**FRs 覆蓋**：FR48, FR49, FR50, FR51, FR52, FR53

---

## Story 8.1: 用戶操作日誌記錄

**As a** 系統,
**I want** 記錄所有用戶操作日誌,
**So that** 可以追蹤誰在何時做了什麼操作。

**Acceptance Criteria:**

**Given** 用戶執行任何操作
**When** 操作完成
**Then** 系統記錄以下資訊：
- 用戶 ID 和用戶名
- 操作類型（創建/讀取/更新/刪除）
- 操作對象（資源類型和 ID）
- 操作時間（精確到毫秒）
- IP 地址和 User Agent
- 操作結果（成功/失敗）

**Given** 敏感操作
**When** 如用戶管理、規則變更、系統配置
**Then** 記錄操作前後的值變化

**Given** 操作日誌
**When** 嘗試修改或刪除
**Then** 系統拒絕操作
**And** 記錄此次嘗試至安全日誌

**技術備註：**
- 創建 `AuditLog` 資料表（append-only）
- 使用 PostgreSQL 觸發器確保不可篡改
- 考慮使用獨立的審計數據庫

**FR 覆蓋**：FR48

---

## Story 8.2: 數據變更追蹤

**As a** 系統,
**I want** 記錄所有數據變更（修改人、時間、原因）,
**So that** 可以完整追蹤數據的演變歷史。

**Acceptance Criteria:**

**Given** 業務數據被修改
**When** 如發票提取結果、規則、用戶資料
**Then** 系統記錄：
- 變更前的完整值
- 變更後的完整值
- 變更人 ID
- 變更時間
- 變更原因（如有）

**Given** 數據有多次變更
**When** 查詢變更歷史
**Then** 可以看到完整的變更鏈
**And** 支援時間軸視圖

**Given** 變更記錄
**When** 查詢特定版本
**Then** 可以查看該時間點的數據快照

**技術備註：**
- 創建 `DataChangeHistory` 資料表
- 使用 JSON 欄位儲存變更前後的值
- 建立索引支援快速查詢

**FR 覆蓋**：FR49

---

## Story 8.3: 處理記錄查詢

**As a** 審計人員,
**I want** 查詢指定期間的處理記錄,
**So that** 我可以進行審計和合規檢查。

**Acceptance Criteria:**

**Given** 審計人員已登入
**When** 導航至「審計查詢」頁面
**Then** 顯示查詢表單，包含：
- 時間範圍（必填）
- 城市（可選）
- Forwarder（可選）
- 處理狀態（可選）
- 操作人（可選）

**Given** 執行查詢
**When** 提交查詢條件
**Then** 返回符合條件的處理記錄列表
**And** 支援分頁（每頁 50 筆）
**And** 顯示總筆數

**Given** 查詢結果
**When** 需要進一步篩選
**Then** 支援在結果內搜尋
**And** 支援按欄位排序

**Given** 大量查詢結果
**When** 結果超過 10,000 筆
**Then** 系統提示縮小查詢範圍
**And** 或使用匯出功能

**FR 覆蓋**：FR50

---

## Story 8.4: 原始文件追溯

**As a** 審計人員,
**I want** 從任何數據點追溯至原始發票文件,
**So that** 我可以驗證數據的來源和準確性。

**Acceptance Criteria:**

**Given** 審計人員查看提取結果
**When** 點擊「查看原始文件」
**Then** 系統顯示原始發票 PDF/圖片

**Given** 審計人員查看修正記錄
**When** 點擊追溯連結
**Then** 系統顯示：
- 原始文件
- 原始 OCR 結果
- 修正前的值
- 修正後的值
- 修正人和時間

**Given** 原始文件
**When** 文件已被移至歸檔儲存
**Then** 系統可以從歸檔中讀取
**And** 載入時間 < 10 秒

**Given** 追溯查詢
**When** 生成追溯報告
**Then** 報告包含完整的數據鏈
**And** 從原始文件到最終結果

**FR 覆蓋**：FR51

---

## Story 8.5: 審計報告匯出

**As a** 審計人員,
**I want** 匯出符合審計要求的報告,
**So that** 可以提供給內部或外部審計使用。

**Acceptance Criteria:**

**Given** 審計人員完成查詢
**When** 點擊「匯出審計報告」
**Then** 顯示報告配置選項：
- 報告類型（處理記錄/變更歷史/完整審計）
- 時間範圍
- 包含欄位
- 輸出格式（Excel/PDF/CSV）

**Given** 選擇「完整審計報告」
**When** 生成報告
**Then** 報告包含：
- 封面和目錄
- 查詢條件摘要
- 處理記錄明細
- 數據變更歷史
- 附件（原始文件清單）

**Given** 報告生成
**When** 報告包含大量數據
**Then** 系統採用背景處理
**And** 完成後發送下載通知

**Given** 生成的報告
**When** 需要驗證完整性
**Then** 報告包含數位簽章或雜湊值
**And** 可以驗證報告未被篡改

**FR 覆蓋**：FR52

---

## Story 8.6: 長期數據保留

**As a** 系統,
**I want** 保留數據和日誌至少 7 年,
**So that** 符合審計和合規要求。

**Acceptance Criteria:**

**Given** 數據和日誌記錄
**When** 達到保留期限（7 年）
**Then** 系統不會自動刪除
**And** 需要管理員手動審批才能清理

**Given** 歷史數據
**When** 超過 1 年
**Then** 系統自動移至歸檔儲存（冷儲存）
**And** 降低儲存成本

**Given** 歸檔數據
**When** 需要查詢
**Then** 系統可以從歸檔中讀取
**And** 支援延遲載入（最長 30 秒）

**Given** 數據保留政策
**When** 系統配置
**Then** 可以設定：
- 活躍儲存期限（預設 1 年）
- 歸檔儲存期限（預設 7 年）
- 清理審批流程

**技術備註：**
- 配置 Azure Blob Storage 生命週期管理
- 實現冷熱數據分層儲存
- 設定保留策略防止意外刪除

**FR 覆蓋**：FR53

---
