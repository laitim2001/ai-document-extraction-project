# Epic 15: 統一 3 層機制到日常處理流程

**目標**：將 Epic 0（歷史數據初始化）中開發的 3 層機制統一整合到日常文件處理流程中，確保每日上傳的發票也能享受相同的智能識別和分類功能

**前置條件**：Epic 0 完成、Epic 13 完成（欄位映射）、Epic 14 完成（Prompt 配置）

---

## 背景說明

目前系統存在兩條獨立的處理流程：

### 歷史數據初始化流程 (Epic 0)
1. ✅ 文件類型檢測（Native PDF / Scanned）
2. ✅ 智能處理路由（雙重處理 / GPT Vision）
3. ✅ 發行者識別（Logo/Header → Company）
4. ✅ 文件格式分類（DocumentFormat）
5. ✅ 術語聚合（Term Aggregation）
6. ✅ AI 術語驗證（GPT-5.2）

### 日常處理流程 (Epic 2-3)
1. ✅ 文件上傳
2. ⚠️ Azure DI 提取（固定配置）
3. ⚠️ 固定欄位映射
4. ✅ 人工審核
5. ❌ 無發行者識別
6. ❌ 無格式分類
7. ❌ 無術語聚合

這導致：
- 日常上傳的發票無法受益於 Company/Format 特定配置
- 新術語無法自動學習
- 系統知識庫不會隨日常使用而增長

### 3 層機制回顧

| 層級 | 名稱 | 功能 | 來源 Epic |
|------|------|------|-----------|
| 第 1 層 | 文件類型檢測 | 區分 Native PDF / Scanned PDF / Image | Epic 0 |
| 第 2 層 | 發行者/格式識別 | 識別 Company + DocumentFormat | Epic 0 |
| 第 3 層 | 術語聚合 | 記錄術語到 Format，建立知識庫 | Epic 0 |

### 統一架構

```
┌─────────────────────────────────────────────────────────────────┐
│                    統一文件處理流程                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐                                               │
│  │ 文件上傳      │                                               │
│  │ (單個/批次)   │                                               │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ 文件類型檢測  │ ← 第 1 層: Native PDF / Scanned              │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ 智能處理路由  │ ← 雙重處理 / GPT Vision Only                 │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ Azure DI 提取 │ ← 基礎欄位提取                               │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ 發行者識別    │ ← 第 2 層: Logo/Header → Company             │
│  │ + 格式匹配    │ ← 第 2 層: DocumentFormat                    │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ 動態配置獲取  │ ← Epic 13: 欄位映射                          │
│  │              │ ← Epic 14: Prompt 配置                        │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ GPT 增強提取  │ ← 使用動態 Prompt                            │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ 欄位映射轉換  │ ← 使用動態映射配置                           │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ 術語記錄      │ ← 第 3 層: 記錄新術語到 Format               │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ 信心度計算    │ ← 綜合評估                                   │
│  └──────┬───────┘                                               │
│         ↓                                                       │
│  ┌──────────────┐                                               │
│  │ 路由決策      │ ← AUTO_APPROVE / QUICK_REVIEW / FULL_REVIEW │
│  └──────────────┘                                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## Story 15.1: 處理流程重構 - 統一入口

**As a** 系統,
**I want** 有一個統一的文件處理管道,
**So that** 所有文件（歷史和日常）都經過相同的智能處理流程。

**Acceptance Criteria:**

**Given** 任何文件進入系統（單個上傳或批次）
**When** 開始處理
**Then** 統一使用 UnifiedDocumentProcessor 服務
**And** 執行完整的 11 步處理管道

**Given** 功能開關 ENABLE_UNIFIED_PROCESSOR = false
**When** 處理文件
**Then** 使用原有處理流程
**And** 確保向後兼容

**Given** 處理過程中某步驟失敗
**When** 該步驟標記為 optional
**Then** 記錄警告並繼續下一步驟
**When** 該步驟標記為 required
**Then** 中斷處理並返回錯誤

**技術要點**：
- UnifiedDocumentProcessor 服務
- 文件類型檢測整合
- 智能路由邏輯
- 功能開關（漸進式啟用）

---

## Story 15.2: 發行者識別整合

**As a** 系統,
**I want** 在日常處理流程中自動識別文件發行者,
**So that** 可以應用 Company 特定的配置。

**Acceptance Criteria:**

**Given** 文件完成基礎提取
**When** 進入發行者識別步驟
**Then** 調用現有的發行者識別服務（Story 0-8）
**And** 獲取識別的公司 ID 和信心度

**Given** 識別到的公司尚未存在
**When** AUTO_CREATE_COMPANY = true
**Then** 自動建立初始 Company Profile
**And** 標記為待確認狀態

**Given** 識別失敗或信心度過低
**When** 信心度 < 50%
**Then** 記錄為待人工確認
**And** 繼續處理（使用預設配置）

**技術要點**：
- 修改 batch-processor.service.ts 調用發行者識別
- 公司匹配/自動創建邏輯
- 識別結果儲存

---

## Story 15.3: 格式匹配與動態配置

**As a** 系統,
**I want** 根據識別的 Company 和 Format 獲取動態配置,
**So that** 每個文件可以使用最適合的處理策略。

**Acceptance Criteria:**

**Given** 發行者識別完成
**When** 需要匹配文件格式
**Then** 根據發行者 + 文件特徵匹配 DocumentFormat
**And** 如無匹配則建立新格式（如 AUTO_CREATE_FORMAT = true）

**Given** Company 和 Format 確定
**When** 獲取動態配置
**Then** 調用 Epic 13 的欄位映射配置 API
**And** 調用 Epic 14 的 Prompt 配置 API
**And** 將配置注入處理上下文

**Given** 無特定配置
**When** 需要使用配置
**Then** 降級使用 Global 配置
**And** 記錄配置來源

**技術要點**：
- 格式匹配服務（基於發行者 + 特徵）
- 動態獲取 Epic 13 的欄位映射配置
- 動態獲取 Epic 14 的 Prompt 配置

---

## Story 15.4: 持續術語學習

**As a** 系統,
**I want** 在日常處理中記錄新術語,
**So that** 系統知識庫可以持續擴展。

**Acceptance Criteria:**

**Given** 文件提取完成
**When** 發現新術語（不在現有術語庫中）
**Then** 將術語記錄到對應的 DocumentFormat
**And** 標記為待驗證狀態

**Given** 人工審核確認術語
**When** 術語被確認為有效
**Then** 更新術語狀態為已驗證
**And** 後續處理自動使用該術語

**Given** 用戶在審核時添加新術語
**When** 完成審核
**Then** 將新術語添加到知識庫
**And** 關聯到當前 Company/Format

**技術要點**：
- 新術語檢測（與現有術語庫比對）
- 術語自動記錄到 Format
- 術語建議機制（人工審核時顯示）

---

## Story 15.5: 信心度計算增強

**As a** 系統,
**I want** 使用多維度因素計算信心度,
**So that** 路由決策更加準確。

**Acceptance Criteria:**

**Given** 文件處理完成
**When** 計算綜合信心度
**Then** 考慮以下因素：
  - 提取信心度（來自 Azure DI）
  - 發行者識別信心度
  - 格式匹配信心度
  - 配置匹配程度
  - 歷史準確率
  - 欄位完整度
  - 術語匹配度

**Given** 計算出綜合信心度
**When** 做出路由決策
**Then** ≥ 90% → AUTO_APPROVE
**And** 70-89% → QUICK_REVIEW
**And** < 70% → FULL_REVIEW

**Given** 配置匹配程度不同
**When** 計算信心度
**Then** specific 配置加 +10% 信心度
**And** company 配置加 +5%
**And** format 配置加 +3%
**And** global 配置加 +1%
**And** default 配置不加分

**技術要點**：
- 多維度信心度計算
- 配置匹配程度影響
- 歷史準確率權重
- 路由決策優化

---

## 依賴關係

```
Epic 15: 統一 3 層機制到日常處理流程
├─ Story 15.1: 處理流程重構 - 統一入口
├─ Story 15.2: 發行者識別整合 (依賴 15.1)
├─ Story 15.3: 格式匹配與動態配置 (依賴 15.2, Epic 13, Epic 14)
├─ Story 15.4: 持續術語學習 (依賴 15.3)
└─ Story 15.5: 信心度計算增強 (依賴 15.2, 15.3, 15.4)
```

---

## 成功指標

| 指標 | 目標 |
|------|------|
| 日常處理自動通過率 | 從 70% 提升至 85% |
| 新術語自動學習覆蓋率 | 95%+ |
| 處理延遲增加 | < 500ms |
| 人工審核工作量減少 | 20%+ |

---

## 實施計劃

### Phase 1: 基礎整合
- Story 15-1: 統一入口
- Story 15-2: 發行者識別

### Phase 2: 動態配置
- Story 15-3: 格式匹配與配置

### Phase 3: 持續學習
- Story 15-4: 術語學習
- Story 15-5: 信心度增強

### 風險緩解
- 使用功能開關漸進式啟用
- 保留原有流程作為降級方案
- 完善的監控和告警

---

## 與其他 Epic 的關係

- **Epic 0**: 3 層機制的基礎實現（上游）
- **Epic 2**: 手動發票上傳流程（受影響）
- **Epic 3**: 發票審核流程（受影響）
- **Epic 9**: 自動化文件獲取（受影響）
- **Epic 13**: 欄位映射配置（上游）
- **Epic 14**: Prompt 配置（上游）

---

*Epic 建立日期: 2026-01-02*
*狀態: 規劃中*
