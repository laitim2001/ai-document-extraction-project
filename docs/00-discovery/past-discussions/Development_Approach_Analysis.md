# Phase 1-4 開發方案對比分析
## 自行開發程式 vs n8n 工作流

---

## 快速結論

| Phase | 建議方案 | 原因 |
|-------|---------|------|
| **Phase 1** | ✅ **Python 程式** | 批量處理 2,230 文件，需要並行、錯誤處理、checkpoint |
| **Phase 2** | ✅ **Python 程式** | SQL 查詢 + 數據處理，簡單腳本即可 |
| **Phase 3** | ✅ **Python 程式** | 批量 API 調用，需要 rate limiting 處理 |
| **Phase 4** | ✅ **簡單 Web UI** | 人工審核需要界面，可用 Streamlit/Retool |
| **Phase 5** | ✅ **n8n 工作流** | 持續運行、事件驅動、多系統集成 |

---

## 詳細分析

### Phase 1: 歷史文件數據初始化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PHASE 1 方案對比                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  任務特點:                                                              │
│  • 批量處理 2,230 個文件 (一次性工作)                                   │
│  • 需要並行處理以提高效率                                               │
│  • 需要錯誤處理和自動重試                                               │
│  • 需要 checkpoint 以防中斷後重新開始                                   │
│  • 處理時間較長 (2-4 小時)                                              │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    n8n 工作流                                    │    │
│  │                                                                  │    │
│  │  優點:                                                          │    │
│  │  • 可視化流程                                                   │    │
│  │  • 不需要寫太多代碼                                             │    │
│  │                                                                  │    │
│  │  缺點:                                                          │    │
│  │  ❌ 不適合處理大量文件 (2,230 個)                               │    │
│  │  ❌ 並行處理能力有限                                            │    │
│  │  ❌ 長時間運行容易 timeout                                      │    │
│  │  ❌ 中斷後難以從 checkpoint 恢復                                │    │
│  │  ❌ Debug 困難                                                  │    │
│  │  ❌ 內存問題 (處理大量數據時)                                   │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐ (不推薦)                                            │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Python 程式                                   │    │
│  │                                                                  │    │
│  │  優點:                                                          │    │
│  │  ✅ 完整的並行處理 (asyncio / multiprocessing)                  │    │
│  │  ✅ 完善的錯誤處理和重試機制                                    │    │
│  │  ✅ Checkpoint 功能，中斷後可恢復                               │    │
│  │  ✅ 進度條顯示 (tqdm)                                           │    │
│  │  ✅ 靈活的日誌記錄                                              │    │
│  │  ✅ 容易 debug 和測試                                           │    │
│  │  ✅ 可以先用小批量測試，再跑全量                                │    │
│  │                                                                  │    │
│  │  缺點:                                                          │    │
│  │  • 需要寫代碼                                                   │    │
│  │  • 需要部署環境                                                 │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐⭐⭐⭐ (強烈推薦)                                    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  結論: Phase 1 使用 Python 程式                                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Phase 2: 術語彙總與去重

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PHASE 2 方案對比                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  任務特點:                                                              │
│  • 純數據庫查詢和聚合                                                   │
│  • 生成統計報告                                                         │
│  • 一次性工作，執行時間短                                               │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    n8n 工作流                                    │    │
│  │                                                                  │    │
│  │  可行但過度:                                                    │    │
│  │  • 只是幾個 SQL 查詢                                            │    │
│  │  • 用 n8n 有點大材小用                                          │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐⭐ (可行但不必要)                                    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Python 程式 / SQL 腳本                        │    │
│  │                                                                  │    │
│  │  優點:                                                          │    │
│  │  ✅ 簡單直接                                                    │    │
│  │  ✅ 可以和 Phase 1 整合在同一個程式中                           │    │
│  │  ✅ 輸出 Excel/CSV 報告                                         │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐⭐⭐⭐ (推薦)                                        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  結論: Phase 2 整合到 Phase 1 的 Python 程式中                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Phase 3: AI 自動分類建議

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PHASE 3 方案對比                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  任務特點:                                                              │
│  • 批量調用 AI API (~1,000 次)                                         │
│  • 需要處理 Rate Limiting                                               │
│  • 需要處理 API 錯誤和重試                                              │
│  • 結果需要結構化存儲                                                   │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    n8n 工作流                                    │    │
│  │                                                                  │    │
│  │  缺點:                                                          │    │
│  │  ❌ Rate Limiting 處理不夠靈活                                  │    │
│  │  ❌ 批量 API 調用效率低                                         │    │
│  │  ❌ 錯誤處理和重試機制有限                                      │    │
│  │  ❌ 難以實現指數退避 (exponential backoff)                      │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐ (不推薦)                                            │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Python 程式                                   │    │
│  │                                                                  │    │
│  │  優點:                                                          │    │
│  │  ✅ 完善的 Rate Limiting 處理                                   │    │
│  │  ✅ 指數退避重試機制                                            │    │
│  │  ✅ 批量處理優化                                                │    │
│  │  ✅ 可以緩存結果，避免重複調用                                  │    │
│  │  ✅ 成本控制 (可以設置上限)                                     │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐⭐⭐⭐ (強烈推薦)                                    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  結論: Phase 3 使用 Python 程式                                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Phase 4: 人工審核確認

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PHASE 4 方案對比                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  任務特點:                                                              │
│  • 需要人機交互界面                                                     │
│  • 需要顯示待審核項目                                                   │
│  • 需要記錄審核結果                                                     │
│  • 需要進度追蹤                                                         │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │               方案 A: Excel + 人工編輯                           │    │
│  │                                                                  │    │
│  │  流程:                                                          │    │
│  │  1. 導出待審核項目到 Excel                                      │    │
│  │  2. 人工在 Excel 中修改                                         │    │
│  │  3. 導入修改後的 Excel                                          │    │
│  │                                                                  │    │
│  │  優點: ✅ 最簡單，不需要開發                                    │    │
│  │  缺點: ❌ 效率較低，需要來回導入導出                            │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐⭐ (可接受，適合少量審核)                            │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │               方案 B: Streamlit Web UI (推薦)                    │    │
│  │                                                                  │    │
│  │  優點:                                                          │    │
│  │  ✅ 開發快速 (半天可完成)                                       │    │
│  │  ✅ Python 生態，和 Phase 1-3 整合容易                          │    │
│  │  ✅ 即時保存，不需要導入導出                                    │    │
│  │  ✅ 可以顯示進度、統計                                          │    │
│  │  ✅ 支持篩選、搜索                                              │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐⭐⭐⭐ (強烈推薦)                                    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │               方案 C: Retool / Appsmith                          │    │
│  │                                                                  │    │
│  │  優點:                                                          │    │
│  │  ✅ 專業的內部工具平台                                          │    │
│  │  ✅ 拖拽式開發                                                  │    │
│  │  ✅ 直接連接數據庫                                              │    │
│  │                                                                  │    │
│  │  缺點:                                                          │    │
│  │  • 需要學習新平台                                               │    │
│  │  • 可能有額外成本                                               │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐⭐⭐ (如果已經在用，是好選擇)                        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  結論: Phase 4 推薦使用 Streamlit 快速建立審核界面                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Phase 5: 正式工作流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PHASE 5 方案對比                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  任務特點:                                                              │
│  • 持續運行的工作流 (7x24)                                              │
│  • 事件驅動 (新文件觸發)                                                │
│  • 多系統集成 (Blob, API, DB, Email)                                    │
│  • 需要監控和告警                                                       │
│  • 需要可視化管理                                                       │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Python 程式                                   │    │
│  │                                                                  │    │
│  │  缺點:                                                          │    │
│  │  ❌ 需要自己實現事件監聽                                        │    │
│  │  ❌ 需要自己實現重試和錯誤處理                                  │    │
│  │  ❌ 需要自己搭建監控                                            │    │
│  │  ❌ 部署和維護複雜                                              │    │
│  │  ❌ 修改流程需要改代碼和重新部署                                │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐ (可行但費力)                                        │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    n8n 工作流 (推薦)                             │    │
│  │                                                                  │    │
│  │  優點:                                                          │    │
│  │  ✅ 原生支持 Webhook 和事件觸發                                 │    │
│  │  ✅ 內建多種集成 (Azure, HTTP, DB, Email)                       │    │
│  │  ✅ 可視化流程，易於理解和修改                                  │    │
│  │  ✅ 內建重試機制                                                │    │
│  │  ✅ 執行歷史和日誌                                              │    │
│  │  ✅ 錯誤通知                                                    │    │
│  │  ✅ 非技術人員也能理解流程                                      │    │
│  │                                                                  │    │
│  │  評分: ⭐⭐⭐⭐⭐ (強烈推薦)                                    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  結論: Phase 5 使用 n8n 工作流                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 最終建議架構

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    推薦的技術架構                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                 一次性準備工作 (Phase 1-4)                       │    │
│  │                                                                  │    │
│  │    使用: Python 程式 + Streamlit UI                             │    │
│  │                                                                  │    │
│  │    ┌───────────────────────────────────────────────────────┐    │    │
│  │    │                                                        │    │    │
│  │    │   invoice_preprocessor/                                │    │    │
│  │    │   ├── main.py              # 主程序入口                │    │    │
│  │    │   ├── config.py            # 配置                      │    │    │
│  │    │   ├── extractors/                                      │    │    │
│  │    │   │   ├── azure_extractor.py    # Azure Doc Intel     │    │    │
│  │    │   │   └── filename_parser.py    # 文件名解析          │    │    │
│  │    │   ├── classifiers/                                     │    │    │
│  │    │   │   ├── universal_mapping.py  # 通用規則            │    │    │
│  │    │   │   └── llm_classifier.py     # AI 分類             │    │    │
│  │    │   ├── database/                                        │    │    │
│  │    │   │   ├── models.py            # 數據模型              │    │    │
│  │    │   │   └── operations.py        # 數據庫操作            │    │    │
│  │    │   ├── reports/                                         │    │    │
│  │    │   │   └── term_summary.py      # 報告生成              │    │    │
│  │    │   └── review_ui/                                       │    │    │
│  │    │       └── streamlit_app.py     # 審核界面              │    │    │
│  │    │                                                        │    │    │
│  │    └───────────────────────────────────────────────────────┘    │    │
│  │                                                                  │    │
│  │    運行方式:                                                    │    │
│  │    $ python main.py --phase 1      # 提取歷史文件              │    │
│  │    $ python main.py --phase 2      # 生成術語報告              │    │
│  │    $ python main.py --phase 3      # AI 分類建議               │    │
│  │    $ streamlit run review_ui/app.py # 啟動審核界面             │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│                              │                                           │
│                              │ 完成後產出: Mapping 規則表               │
│                              ▼                                           │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                 持續運行工作流 (Phase 5)                         │    │
│  │                                                                  │    │
│  │    使用: n8n 工作流                                             │    │
│  │                                                                  │    │
│  │    ┌───────────────────────────────────────────────────────┐    │    │
│  │    │                                                        │    │    │
│  │    │   Workflow 1: 文件處理主流程                           │    │    │
│  │    │   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐    │    │    │
│  │    │   │Blob │──▶│Parse│──▶│Azure│──▶│ Map │──▶│Save │    │    │    │
│  │    │   │Event│   │Name │   │ Doc │   │Class│   │ DB  │    │    │    │
│  │    │   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘    │    │    │
│  │    │                                                        │    │    │
│  │    │   Workflow 2: 低置信度 AI 輔助                         │    │    │
│  │    │   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐              │    │    │
│  │    │   │Queue│──▶│ PDF │──▶│GPT4o│──▶│Update│              │    │    │
│  │    │   │Item │   │toImg│   │ API │   │ DB  │              │    │    │
│  │    │   └─────┘   └─────┘   └─────┘   └─────┘              │    │    │
│  │    │                                                        │    │    │
│  │    │   Workflow 3: 通知和報告                               │    │    │
│  │    │   ┌─────┐   ┌─────┐   ┌─────┐                         │    │    │
│  │    │   │Sched│──▶│Query│──▶│Email│                         │    │    │
│  │    │   │Daily│   │Stats│   │/Team│                         │    │    │
│  │    │   └─────┘   └─────┘   └─────┘                         │    │    │
│  │    │                                                        │    │    │
│  │    └───────────────────────────────────────────────────────┘    │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                 共用組件                                         │    │
│  │                                                                  │    │
│  │    • PostgreSQL 數據庫 (存儲所有數據)                           │    │
│  │    • Azure Blob Storage (存儲原始文件)                          │    │
│  │    • Azure Document Intelligence (OCR 提取)                     │    │
│  │    • Azure OpenAI (AI 分類)                                     │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 為什麼這樣分配？

### 核心原則

| 任務類型 | 適合工具 | 原因 |
|---------|---------|------|
| **一次性批量處理** | Python | 需要精細控制、錯誤處理、並行優化 |
| **持續運行工作流** | n8n | 事件驅動、可視化、易維護 |
| **人機交互界面** | Streamlit/Retool | 快速開發、良好 UX |

### Phase 1-3 為什麼用 Python？

```
┌─────────────────────────────────────────────────────────────────────────┐
│  批量處理 2,230 個文件的挑戰:                                           │
│                                                                          │
│  1. 並行處理                                                            │
│     n8n: ❌ 並行能力有限，可能需要幾十小時                              │
│     Python: ✅ asyncio 並行，2-4 小時完成                               │
│                                                                          │
│  2. 錯誤處理                                                            │
│     n8n: ❌ 一個失敗可能導致整個流程停止                                │
│     Python: ✅ 單獨處理每個文件，失敗的記錄下來繼續                      │
│                                                                          │
│  3. Checkpoint                                                          │
│     n8n: ❌ 沒有原生 checkpoint 支持                                    │
│     Python: ✅ 每 100 個文件保存進度，中斷後可恢復                       │
│                                                                          │
│  4. Debug                                                               │
│     n8n: ❌ 難以在本地測試和調試                                        │
│     Python: ✅ 可以先用 10 個文件測試，沒問題再跑全量                    │
│                                                                          │
│  5. 資源控制                                                            │
│     n8n: ❌ 長時間運行可能 timeout 或內存溢出                           │
│     Python: ✅ 完全控制內存和運行時間                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Phase 5 為什麼用 n8n？

```
┌─────────────────────────────────────────────────────────────────────────┐
│  持續運行工作流的需求:                                                  │
│                                                                          │
│  1. 事件驅動                                                            │
│     Python: ❌ 需要自己寫 polling 或 webhook 服務器                     │
│     n8n: ✅ 原生支持 Webhook、Schedule、Event Trigger                   │
│                                                                          │
│  2. 可視化                                                              │
│     Python: ❌ 流程在代碼中，非技術人員難以理解                          │
│     n8n: ✅ 拖拽式流程圖，一目了然                                      │
│                                                                          │
│  3. 修改和維護                                                          │
│     Python: ❌ 修改需要改代碼、測試、部署                                │
│     n8n: ✅ 直接在界面上修改，即時生效                                  │
│                                                                          │
│  4. 監控                                                                │
│     Python: ❌ 需要自己搭建監控系統                                     │
│     n8n: ✅ 內建執行歷史、錯誤日誌、通知                                │
│                                                                          │
│  5. 集成                                                                │
│     Python: ❌ 每個集成需要自己寫代碼                                   │
│     n8n: ✅ 400+ 預建集成節點                                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 開發時間估算

| Phase | 方案 | 預計開發時間 | 執行時間 |
|-------|-----|-------------|---------|
| Phase 1 | Python 批量提取 | 2-3 天 | 2-4 小時 |
| Phase 2 | Python 報告 (整合到 P1) | 已包含 | 10 分鐘 |
| Phase 3 | Python AI 分類 | 1 天 | 30 分鐘 - 1 小時 |
| Phase 4 | Streamlit 審核 UI | 1 天 | 人工 10-20 小時 |
| Phase 5 | n8n 工作流 | 2-3 天 | 持續運行 |
| **總計** | | **6-8 天** | |

---

## 總結

| 決策 | 選擇 | 原因 |
|------|------|------|
| Phase 1-3 | **Python 程式** | 批量處理需要精細控制 |
| Phase 4 | **Streamlit UI** | 快速開發審核界面 |
| Phase 5 | **n8n 工作流** | 持續運行需要可視化和易維護 |

這樣的分配讓你：
- **Phase 1-4**：最大靈活性和控制力
- **Phase 5**：最佳的可維護性和可視化

需要我提供 Phase 1-3 的 Python 代碼框架嗎？
