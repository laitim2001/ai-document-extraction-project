# generated: 2025-12-15
# project: ai-document-extraction-project
# tracking_system: file-system
# story_location: docs/04-implementation/stories

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic not yet started
#   - in-progress: Epic actively being worked on
#   - done: All stories in epic completed
#
# Epic Status Transitions:
#   - backlog → in-progress: Automatically when first story is created (via create-story)
#   - in-progress → done: Manually when all stories reach 'done' status
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - drafted: Story file created in stories folder
#   - ready-for-dev: Draft approved and story context created
#   - in-progress: Developer actively working on implementation
#   - review: Ready for code review (via Dev's code-review workflow)
#   - done: Story completed
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - completed: Retrospective has been done
#
# WORKFLOW NOTES:
# ===============
# - Epic transitions to 'in-progress' automatically when first story is created
# - Stories can be worked in parallel if team capacity allows
# - SM typically drafts next story after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', then runs code-review (fresh context, different LLM recommended)

generated: 2025-12-15
project: ai-document-extraction-project
tracking_system: file-system
story_location: docs/04-implementation/stories

development_status:
  # ============================================================
  # Epic 0: 歷史數據初始化（前置 Epic）
  # ============================================================
  epic-0: done  # All 11 stories completed (0-1 to 0-11)
  0-1-batch-file-upload-metadata-detection: done  # Completed 2025-12-23: BatchFileUploader, HistoricalFileList, file-detection.service, upload/files/bulk APIs, HistoricalBatch/HistoricalFile models
  0-2-intelligent-processing-routing: done  # Completed 2025-12-23: ProcessingMethod enum, processing-router.service, cost-estimation.service, ProcessingConfirmDialog, batch-processor integration, gpt-vision.service, result API
  0-3-just-in-time-company-profile: done  # Completed 2025-12-23: Company model, company-matcher.service (3-tier matching), company-auto-create.service, CompanyTypeSelector, CompanyMergeDialog, pending/update/merge APIs, admin review page
  0-4-batch-processing-progress-tracking: done  # Completed 2025-12-23: BatchProgressPanel, BatchErrorList, BatchSummaryCard, batch-progress.service, SSE progress API, pause/resume/cancel/retry/skip APIs, PAUSED status, ADMIN permissions
  0-5-term-aggregation-initial-rules: done  # Completed 2025-12-24: TermAggregationService, TermClassificationService (GPT-5.2), TermTable, TermFilters, BulkRuleActions, RuleCreationPanel, bulk CRUD APIs, undo API, StandardChargeCategory, BulkOperation model
  0-6-batch-company-integration: done  # Completed 2025-12-25: Prisma Schema extensions (HistoricalBatch/HistoricalFile company fields), batch-company.ts types, identifyCompanyForFile helper in batch-processor.service, company-stats API, CreateBatchDialog UI with company identification config (Switch/Slider), use-historical-data hook extensions
  0-7-batch-term-aggregation-integration: done  # Completed 2025-12-25: BatchTermAggregationService (aggregateTermsForBatch, per-company grouping, universal term detection), TermAggregationResult model, AGGREGATING/AGGREGATED BatchStatus states, term-stats API (GET/POST/DELETE), TermAggregationSummary component, CreateBatchDialog term aggregation config (Switch/Slider), use-term-aggregation hook
  0-8-document-issuer-identification: done  # Completed 2025-12-26: document-issuer.service.ts (extractDocumentIssuer, matchIssuerToCompany, processTransactionParties), document-issuer.ts types (DocumentIssuerResult, TransactionParty), IssuerIdentificationMethod enum, FileTransactionParty model, METHOD_PRIORITY_WEIGHTS, 三層匹配策略
  0-9-document-format-term-reorganization: done  # Completed 2025-12-26: document-format.service.ts (processDocumentFormat, matchOrCreateFormat), hierarchical-term-aggregation.service.ts (aggregateTermsHierarchically, Company→Format→Terms三層結構), DocumentType/DocumentSubtype enums, DocumentFormat model, HierarchicalTermAggregation types
  0-10-ai-term-validation-service: done  # Completed 2025-01-01: ai-term-validator.service.ts (GPT-5.2 semantic validation, 11 TermCategory enum, batch processing 50/batch, maxConcurrency: 3), term-validation.ts types, integrated into batch/hierarchical-term-aggregation services, POST/GET /api/v1/admin/terms/validate, GET /api/v1/admin/costs/term-validation, in-memory cost tracking, 8 story points
  0-11-gpt-vision-prompt-optimization: done  # Completed 2025-01-02: 5-step Prompt structure (Region/Extract/Exclude/Negative/Verify), Prompt version management (V1.0.0/V2.0.0), ExcludedItem tracking, getExtractionPrompt() function, 5 story points
  epic-0-retrospective: optional

  # ============================================================
  # REFACTOR: Forwarder → Company 模型重構
  # ============================================================
  refactor-001-forwarder-to-company: done  # Completed with Story 0-3: Company model with CompanyType, CompanyStatus, CompanySource enums

  # ============================================================
  # Epic 1: 用戶認證與存取控制
  # ============================================================
  epic-1: done  # All stories completed 2025-12-18
  1-0-project-init-foundation: done
  1-1-azure-ad-sso-login: done
  1-2-user-database-role-foundation: done  # Completed 2025-12-18: DB migration + seed executed
  1-3-user-list-search: done  # Completed 2025-12-18: User list page with search, filter, pagination
  1-4-add-user-role-assignment: done  # Completed 2025-12-18: Add User dialog with role assignment
  1-5-modify-user-role-city: done  # Completed 2025-12-18: Edit user dialog, update API, audit logging
  1-6-disable-enable-user-account: done  # Completed 2025-12-18: User status toggle, API endpoint, audit logging
  1-7-custom-role-management: done  # Completed 2025-12-18: Role CRUD, permission selector UI, system role protection
  1-8-city-manager-user-management: done  # Completed 2025-12-18: City permission middleware, city service, API filtering
  epic-1-retrospective: optional

  # ============================================================
  # Epic 2: 手動發票上傳與 AI 處理
  # ============================================================
  epic-2: done  # All stories completed 2025-12-18
  2-1-file-upload-interface-validation: done  # Completed 2025-12-18: Upload UI with drag-drop, validation, preview
  2-2-file-ocr-extraction-service: done  # Completed 2025-12-18: Python OCR service, Azure DI integration, Next.js API
  2-3-forwarder-auto-identification: done  # Completed 2025-12-18: Forwarder model, pattern matching service, confidence scoring
  2-4-field-mapping-extraction: done  # Completed 2025-12-18: MappingRule/ExtractionResult models, field definitions, Python mapper, API routes, seed data
  2-5-confidence-score-calculation: done  # Completed 2025-12-18: Multi-factor weighted scoring, confidence types, calculator, historical accuracy service, UI components, API endpoints
  2-6-processing-path-auto-routing: done  # Completed 2025-12-18: ProcessingQueue model, routing types/config, router logic, routing service, API endpoints
  2-7-processing-status-tracking-display: done  # Completed 2025-12-18: Document list page, status badges, retry button, dynamic polling
  epic-2-retrospective: optional

  # ============================================================
  # Epic 3: 發票審核與修正工作流
  # ============================================================
  epic-3: done  # All stories completed 2025-12-18
  3-1-pending-review-invoice-list: done  # Completed 2025-12-18: Review queue API, hooks, UI components, page
  3-2-side-by-side-pdf-review-interface: done  # Completed 2025-12-18: PDF viewer, review panel, resizable layout, field-source linking
  3-3-confidence-color-coding-display: done  # Completed 2025-12-18: Color coding, tooltip, low confidence filter
  3-4-confirm-extraction-result: done  # Completed 2025-12-18: Approve API, ReviewRecord model, audit logging, ApprovalConfirmDialog, QuickReviewMode
  3-5-correct-extraction-result: done  # Completed 2025-12-18: FieldEditor, correct API, useSaveCorrections hook, UnsavedChangesGuard, field validation
  3-6-correction-type-marking: done  # Completed 2025-12-18: CorrectionType enum, RuleSuggestion model, correctionAnalyzer, notification service, CorrectionTypeDialog
  3-7-escalate-complex-cases: done  # Completed 2025-12-18: Escalation model, EscalationDialog, escalate API, useEscalateReview hook, Super User notification
  3-8-super-user-handle-escalated-cases: done  # Completed 2025-12-18: Escalation list/detail APIs, hooks, UI components, resolve workflow
  epic-3-retrospective: optional

  # ============================================================
  # Epic 4: 映射規則管理與自動學習
  # ============================================================
  epic-4: done  # All stories completed 2025-12-19
  4-1-mapping-rule-list-view: done  # Completed 2025-12-18: Rule list page, filters, detail view, API endpoints, React Query hooks
  4-2-suggest-new-mapping-rule: done  # Completed 2025-12-18: New rule form, pattern editors, test panel, API endpoints, React Query hooks
  4-3-correction-pattern-recording-analysis: done  # Completed 2025-12-19: Correction model, CorrectionPattern, PatternAnalysisLog, similarity algorithms, pattern analysis service, cron job API
  4-4-rule-upgrade-suggestion-generation: done  # Completed 2025-12-19: RuleSuggestion types, rule inference engine, suggestion generator service, API routes, React Query hooks
  4-5-rule-impact-scope-analysis: done  # Completed 2025-12-19: Impact types, ImpactAnalysisService, RuleSimulationService, API routes, React Query hooks, UI components
  4-6-review-learning-rule: done  # Completed 2025-12-19: Review types, approve/reject APIs, useRuleApprove/useRuleReject hooks, ReviewDetailPage, ApproveDialog, RejectDialog, ImpactSummaryCard, SampleCasesTable, review pages
  4-7-rule-version-history-management: done  # Completed 2025-12-19: Version types, versions/compare/rollback APIs, useVersions hooks, VersionDiffViewer, RollbackConfirmDialog, VersionCompareDialog, history page
  4-8-rule-auto-rollback: done  # Completed 2025-12-19: Accuracy types, RollbackLog/Notification models, RuleAccuracyService, AutoRollbackService, accuracy/rollback-logs APIs, useAccuracy/useRollback hooks, AccuracyMetrics component, rollback-history page
  epic-4-retrospective: optional

  # ============================================================
  # Epic 5: Forwarder 配置管理
  # ============================================================
  epic-5: done  # All stories completed 2025-12-19
  5-1-forwarder-profile-list: done  # Completed 2025-12-19: Forwarder list page with search, filter, sort, pagination
  5-2-forwarder-detail-config-view: done  # Completed 2025-12-19: Detail page with tabs, stats panel, rules table, recent documents
  5-3-edit-forwarder-mapping-rules: done  # Completed 2025-12-19: RuleChangeRequest flow, RuleEditForm, pattern editors, preview panel, ForwarderRulesTable integration
  5-4-test-rule-change-effect: done  # Completed 2025-12-19: RuleTestTask/Detail models, rule-testing.service, test APIs, PDF/Excel reports, React Query hooks, test page UI
  5-5-add-disable-forwarder-profile: done  # Completed 2025-12-19: ForwarderForm, LogoUploader, Azure Blob service, create/update/deactivate/activate APIs, ForwarderActions dialogs
  epic-5-retrospective: optional

  # ============================================================
  # Epic 6: 多城市數據隔離
  # ============================================================
  epic-6: done  # All stories completed 2025-12-19
  6-1-city-data-model-rls-config: done  # Completed 2025-12-19: Region/City/UserCityAccess models, RLS policies, city-access.service, NextAuth integration, seed data
  6-2-city-user-data-access-control: done  # Completed 2025-12-19: API city filter middleware, resource access validator, security log service, useUserCity hook, CityIndicator/CityRestricted components
  6-3-regional-manager-cross-city-access: done  # Completed 2025-12-19: UserRegionAccess model, RegionalManagerService, accessible cities API, city filter hook/components, city comparison API/component, multi-city export API/dialog
  6-4-global-admin-full-access: done  # Completed 2025-12-19: SystemConfig/ConfigHistory models, GlobalAdminService, SystemConfigService, global analytics API, config management API, GlobalDashboard page, RegionView, CityRankings, GlobalTrend, SystemConfigPage
  6-5-global-rule-sharing-mechanism: done  # Completed 2025-12-19: RuleCacheVersion model, RuleResolver service, ForwarderIdentifier service, RuleMetricsService, version/metrics APIs, useRuleVersion hook, cache invalidation integration
  epic-6-retrospective: optional

  # ============================================================
  # Epic 7: 報表儀表板與成本追蹤
  # ============================================================
  epic-7: done  # Completed 2025-12-20: All 10 stories completed
  7-1-processing-statistics-dashboard: done  # Completed 2025-12-19: Dashboard types, DashboardStatisticsService with caching, StatCard component, DashboardStats container, React Query integration
  7-2-time-range-filter: done  # Completed 2025-12-19: DateRange types, date-range-utils, url-params, DateRangeContext with URL sync, DateRangePicker, DateRangeQuickSelect, useDashboardStatistics hook, DashboardStats integration
  7-3-forwarder-filter: done  # Completed 2025-12-19: ForwarderOption types, DashboardFilterContext, ForwarderMultiSelect, ForwarderComparisonChart, ControlledDateRangePicker, forwarders/list API
  7-4-expense-detail-report-export: done  # Completed 2025-12-19: ReportJob model, ExcelJS export, Azure Blob storage, ExpenseReportService, export/estimate APIs, ExportDialog component, background job processing
  7-5-cross-city-summary-report: done  # Completed 2025-12-19: Regional report types, RegionalReportService with caching, summary/city-detail/export APIs, CityComparisonTable, CityDetailPanel, RegionalReportContent, permission-controlled page
  7-6-ai-api-usage-cost-display: done  # Completed 2025-12-19: ApiProvider/ApiUsageLog/ApiPricingConfig models, ai-cost.service, summary/trend/anomalies/daily APIs, AiCostCard, AiCostReportContent, useAiCost hooks
  7-7-city-processing-volume-tracking: done  # Completed 2025-12-19: ProcessingStatistics/HourlyProcessingStats/StatisticsAuditLog models, processing-stats.service, aggregated/cities/realtime/reconcile APIs, document-processed handler, useProcessingStats hooks
  7-8-city-ai-cost-tracking: done  # Completed 2025-12-19: ApiPricingHistory model, CityCostService, city-summary/city-trend/comparison APIs, pricing CRUD APIs, useCityCost hooks
  7-9-city-cost-report: done  # Completed 2025-12-19: CityCostReportService (AI+labor cost), anomaly detection, city-cost/trend/anomaly APIs, useCityCostReport hooks, CityCostTable, CostAnomalyDialog, cost report page
  7-10-monthly-cost-allocation-report: done  # Completed 2025-12-20: MonthlyReport model, MonthlyCostReportService, Excel/PDF generation, API routes, React Query hooks, MonthPicker, MonthlyReportDialog, reports/monthly page
  epic-7-retrospective: optional

  # ============================================================
  # Epic 8: 審計追溯與合規
  # ============================================================
  epic-8: done  # Completed 2025-12-20: All 6 stories completed
  8-1-user-operation-log-recording: done  # Completed 2025-12-20: AuditLog/SecurityLog models, immutability triggers, AuditLogService batch/sync writing, withAuditLog middleware, type definitions
  8-2-data-change-tracking: done  # Completed 2025-12-20: DataChangeHistory model, HistoryChangeType enum, change-tracking types, ChangeTrackingService, Prisma middleware, history/compare APIs, ChangeHistoryTimeline/VersionCompareDialog components, useChangeHistory hooks
  8-3-processing-record-query: done  # Completed 2025-12-20: AuditQueryParams/AuditQueryResult/ProcessingRecord types, AuditQueryService, POST /api/audit/query and /count APIs, AuditQueryForm/AuditResultTable components, useAuditQuery hooks, audit query page
  8-4-original-file-traceability: done  # Completed 2025-12-20: TraceabilityReport model, traceability types, azure-blob storage functions, TraceabilityService, source/trace/report APIs, DocumentTraceView component, useTraceability hooks
  8-5-audit-report-export: done  # Completed 2025-12-20: AuditReportJob/AuditReportDownload models, audit-report types, AuditReportService (Excel/PDF/CSV/JSON), SHA-256 checksum + signature, reports APIs, AuditReportExportDialog, AuditReportJobList, ReportIntegrityDialog, useAuditReports hooks
  8-6-long-term-data-retention: done  # Completed 2025-12-20: DataRetentionPolicy/DataArchiveRecord/DataDeletionRequest/DataRestoreRequest models, DataRetentionService, policies/archives/restore/deletion/metrics APIs, useRetention hooks, StorageMetricsCard, RetentionPolicyList, ArchiveRecordList, DeletionRequestList, DataRetentionDashboard
  epic-8-retrospective: optional

  # ============================================================
  # Epic 9: 自動化文件獲取
  # ============================================================
  epic-9: done  # Completed 2025-12-20: All 5 stories completed
  9-1-sharepoint-file-monitoring-api: done  # Completed 2025-12-20: SharePoint types, Prisma models (ApiKey, SharePointConfig, SharePointFetchLog), EncryptionService, MicrosoftGraphService, SharePointDocumentService, ApiKeyService, POST/GET APIs
  9-2-sharepoint-connection-config: done  # Completed 2025-12-20: SharePointConfigService, admin API routes (CRUD, test), SharePointConfigForm, SharePointConfigList, useSharePointConfig hooks, connection testing
  9-3-outlook-mail-attachment-extraction-api: done  # Completed 2025-12-20: Outlook types, OutlookConfig/FilterRule/FetchLog models, OutlookMailService, OutlookDocumentService (dual mode), API Key permissions, POST/GET APIs
  9-4-outlook-connection-config: done  # Completed 2025-12-20: OutlookConfigService, admin CRUD APIs, filter rules management, connection testing, React Query hooks, OutlookConfigForm/List/FilterRulesEditor, admin page
  9-5-auto-retrieval-source-tracking: done  # Completed 2025-12-20: SourceMetadata types, SOURCE_TYPE_CONFIG constants, DocumentSourceService, 4 API routes (source/stats/trend/search), 5 React components (SourceInfoCard, SourceTypeBadge, SourceTypeStats, SourceTypeTrend, SourceSearchFilter)
  epic-9-retrospective: optional

  # ============================================================
  # Epic 10: n8n 工作流整合
  # ============================================================
  epic-10: done  # Completed 2025-12-20: All 7 stories completed
  10-1-n8n-bidirectional-communication-api: done  # Completed 2025-12-20: N8nApiKey/N8nApiCall/N8nIncomingWebhook/WorkflowExecution models, n8n types, n8nApiKeyService/n8nDocumentService/n8nWebhookService, n8nApiMiddleware, 4 API routes (api-keys, documents, status, webhook)
  10-2-webhook-config-management: done  # Completed 2025-12-20: WebhookConfig/WebhookConfigHistory models, AES-256-GCM encryption utility, webhook config types, WebhookConfigService, 5 API routes (list/create, get/update/delete, test, history), React Query hooks
  10-3-workflow-execution-status-view: done  # Completed 2025-12-20: WorkflowExecution/WorkflowExecutionStep models, workflow-execution types, WorkflowExecutionService, 4 API routes (list, detail, running, stats), React Query hooks with polling
  10-4-manual-trigger-workflow: done  # Completed 2025-12-20: WorkflowDefinition model, workflow-trigger types, WorkflowTriggerService, WorkflowDefinitionService, triggerable/trigger/retry/cancel APIs, useWorkflowTrigger hooks
  10-5-workflow-error-detail-view: done  # Completed 2025-12-20: workflow-error types, error-types constants, WorkflowErrorService (error detail/statistics/classification), error detail API, statistics API, useWorkflowError hooks
  10-6-document-processing-progress-tracking: done  # Completed 2025-12-20: DocumentProcessingStage model, 10-stage processing flow, weighted progress calculation, DocumentProgressService, progress/processing/stats APIs, useDocumentProgress hooks
  10-7-n8n-connection-status-monitoring: done  # Completed 2025-12-20: SystemHealthLog/N8nConnectionStats/AlertRecord models, health-monitoring types, N8nHealthService, AlertService, 8 API routes (health status, history, changes, alerts CRUD/summary), React Query hooks
  epic-10-retrospective: optional

  # ============================================================
  # Epic 11: 對外 API 服務
  # ============================================================
  epic-11: done  # Completed 2025-12-21: All 6 stories completed
  11-1-api-invoice-submission-endpoint: done  # Completed 2025-12-20: POST /api/v1/invoices, three submission methods (multipart/Base64/URL), API Key auth, rate limiting, audit logging
  11-2-api-processing-status-query-endpoint: done  # Completed 2025-12-21: GET /api/v1/invoices/{taskId}/status, GET /api/v1/invoices (list), POST /api/v1/invoices/batch-status, RFC 7807 error format
  11-3-api-processing-result-retrieval-endpoint: done  # Completed 2025-12-21: GET /api/v1/invoices/{taskId}/result (JSON/CSV/XML), GET /api/v1/invoices/{taskId}/result/fields/{fieldName}, GET /api/v1/invoices/{taskId}/document, POST /api/v1/invoices/batch-results
  11-4-webhook-notification-service: done  # Completed 2025-12-21: WebhookService, HMAC-SHA256 signature, 4 event types, retry mechanism (1/5/30min), WebhookEventTrigger, GET /api/v1/webhooks (history), POST /api/v1/webhooks/{deliveryId}/retry, GET /api/v1/webhooks/stats
  11-5-api-access-control-authentication: done  # Completed 2025-12-21: ApiKeyService (SHA-256 hash, Bearer Token auth), ApiAuditLogService (batch write, sensitive filtering), admin API routes (CRUD, rotate, stats), CreateApiKeyDialog, ApiKeyManagement page, types/constants for external API auth
  11-6-api-documentation-developer-support: done  # Completed 2025-12-21: OpenAPI 3.0.3 spec (openapi/spec.yaml), Swagger UI (/docs), SDK examples page (/docs/examples), API routes (/api/openapi, /api/docs/error-codes, /api/docs/version, /api/docs/examples), TypeScript/Python/C# code samples, syntax highlighting
  epic-11-retrospective: optional

  # ============================================================
  # Epic 12: 系統管理與監控
  # ============================================================
  epic-12: done  # Completed 2025-12-21: All 7 stories completed
  12-1-system-health-monitoring-dashboard: done  # Completed 2025-12-21: HealthCheckService, API routes, HealthDashboard, useHealthMonitoring hooks, admin health page
  12-2-performance-metrics-tracking: done  # Completed 2025-12-21: Prisma models (ApiPerformanceMetric, SystemResourceMetric, AiServiceMetric, DatabaseQueryMetric, PerformanceHourlySummary, PerformanceThreshold), PerformanceCollector (batch writing), PerformanceService (percentile calculation), 4 API routes, usePerformance hooks, PerformanceDashboard page
  12-3-error-alert-configuration: done  # Completed 2025-12-21: AlertRule/Alert/AlertRuleNotification models, alert-rule.service, alert-evaluation.service, alert-notification.service, alert-evaluation-job, 9 API routes, useAlertRules/useAlerts hooks, AlertRuleTable/CreateAlertRuleDialog/AlertRuleManagement/AlertHistory UI components
  12-4-system-configuration-management: done  # Completed 2025-12-21: SystemConfig/ConfigHistory models, encryption/cache service, React Query hooks, 10 API routes, ConfigManagement UI, config seed data
  12-5-data-backup-management: done  # Completed 2025-12-21: Backup/BackupSchedule/BackupStorageUsage models, BackupService, BackupSchedulerService, 18 API routes, React Query hooks, BackupManagement/BackupList/CreateBackupDialog/ScheduleDialog UI components
  12-6-data-recovery-functionality: done  # Completed 2025-12-21: RestoreRecord/RestoreDrill/RestoreLog models, RestoreService, 8 API routes (list/create/detail/cancel/logs/rollback/preview/stats), useRestore hooks, RestoreManagement/RestoreDialog/RestoreDetailDialog/RestoreList UI components
  12-7-system-log-query: done  # Completed 2025-12-21: SystemLog/LogRetentionPolicy/LogExport models, LogQueryService, LoggerService (async context), 8 API routes (list/detail/related/stats/export/stream/retention), use-logs hooks (SSE streaming), LogViewer/LogDetailDialog/LogExportDialog/LogStreamPanel UI components
  epic-12-retrospective: optional

  # ============================================================
  # Epic 13: 文件預覽與欄位映射
  # ============================================================
  epic-13: done  # All 8 stories completed (2026-01-18)
  13-1-document-preview-field-highlight: done  # Completed 2026-01-02: PDFViewer (react-pdf), FieldHighlightOverlay (bounding box → screen coordinate), PDFControls (zoom/navigation), DynamicPDFViewer (SSR-safe), PDFLoadingSkeleton, PDFErrorDisplay, usePdfPreload hook, coordinate-transform utilities
  13-2-extracted-fields-panel: done  # Completed 2026-01-02: ExtractedFieldsPanel (field list with filtering/sorting/grouping), FieldCard (confidence color coding, inline editing, source labels), FieldFilters (search/confidence/source/sort controls), extracted-field.ts types (ExtractedField, FieldSource, ConfidenceLevel, FieldCategory, FieldFilterState)
  13-3-field-mapping-config-ui: done  # Completed 2026-01-03: MappingConfigPanel (主面板), ConfigSelector (GLOBAL/COMPANY/FORMAT 3層), SortableRuleItem (@dnd-kit draggable), MappingRuleList (drag-drop sorting), SourceFieldSelector (多選), TargetFieldSelector (單選), TransformConfigPanel (5種轉換), RuleEditor (編輯對話框), MappingPreview (即時預覽), index.ts exports
  13-4-mapping-config-api: done  # Completed 2026-01-02: FieldMappingConfig/FieldMappingRule Prisma models (3-scope hierarchy: GLOBAL→COMPANY→FORMAT), 5 transform types (DIRECT/CONCAT/SPLIT/LOOKUP/CUSTOM), 12 API endpoints (CRUD configs, CRUD rules, reorder, test, export/import), optimistic locking with version field, cascade delete, RFC 7807 error responses
  13-5-dynamic-field-mapping-integration: done  # Completed 2026-01-02: DynamicMappingService (主服務入口，整合所有映射組件), ConfigResolver (3-layer priority: FORMAT>COMPANY>GLOBAL), TransformExecutor (Strategy Pattern, 5 transform types), FieldMappingEngine (規則套用引擎), MappingCache (TTL快取, LRU eviction), MappingPipelineStep (管線步驟整合), field-mapping.ts types
  13-6-document-preview-integration-page: done  # Completed 2026-01-03: 整合測試頁面 - 整合 PDFViewer, ExtractedFieldsPanel, MappingConfigPanel 到單一 admin 頁面 (/admin/document-preview-test)，Zustand 狀態管理 (document-preview-test-store.ts)，TestFileUploader/TestToolbar 組件，ResizablePanelGroup 三欄佈局，13 story points
  13-7-field-mapping-admin-page: done  # Completed 2026-01-07: Field Mapping 後台管理頁面 - use-field-mapping-configs.ts (React Query Hooks: 10 hooks + transformToVisualConfig helper), 列表頁 (page.tsx: 表格+篩選+刪除確認), 新增頁 (new/page.tsx: MappingConfigPanel+標準欄位定義), 編輯頁 ([id]/page.tsx: 載入配置+規則同步邏輯), 13 story points
  13-8-invoice-detail-page: done  # Completed 2026-01-18: InvoiceDetailHeader/Stats/Tabs/ProcessingTimeline/InvoiceAuditLog 組件, useInvoiceDetail hook (React Query + 3秒輪詢), DynamicPDFViewer/ExtractedFieldsPanel 整合, i18n 翻譯 (en/zh-TW/zh-CN invoices.detail namespace)
  epic-13-retrospective: optional

  # ============================================================
  # Epic 14: Prompt 配置與動態生成
  # ============================================================
  epic-14: done  # 4 stories completed 2026-01-03
  14-1-prompt-config-model-api: done  # Completed 2026-01-02: PromptConfig model (PromptType/PromptScope/MergeStrategy enums), 3-tier scope hierarchy (GLOBAL→COMPANY→FORMAT), CRUD APIs (/v1/prompt-configs), Zod validation schemas, optimistic locking (version field), unique constraint, RFC 7807 error responses
  14-2-prompt-config-management-ui: done  # Completed 2026-01-02: PromptConfigList (按類型分組), PromptConfigForm (react-hook-form + zod), PromptEditor (語法高亮), PromptTester (文件上傳測試), PromptConfigFilters, prompt-config-ui.ts types, use-prompt-configs.ts hooks, page routes (list/new/edit)
  14-3-prompt-resolution-merge-service: done  # Completed 2026-01-03: PromptResolverService (3-tier chain resolution: FORMAT>COMPANY>GLOBAL), PromptMergeEngine (OVERRIDE/APPEND/PREPEND), PromptVariableEngine (10 built-in providers: companyName, knownTerms, formatName, currentDate, etc.), PromptCache (5-min TTL, pattern invalidation), POST /api/prompts/resolve, GET /api/prompts/resolve (supported variables)
  14-4-gpt-vision-service-integration: done  # Completed 2026-01-03: feature-flags.ts (3 env-driven flags), IPromptProvider interface (PromptType enum, PromptResult), StaticPrompts (4 prompts: ISSUER_ID/TERM_CLASS/FIELD_EXTRACT/VALIDATION), HybridPromptProvider (dynamic→static fallback), GPTVisionService integration (processSingleImage, classifyDocument with dynamic prompts), PromptMetrics for monitoring
  epic-14-retrospective: optional

  # ============================================================
  # Epic 15: 統一 3 層機制到日常處理流程
  # ============================================================
  epic-15: done  # 5/5 stories completed
  15-1-unified-processor-entry: done  # Completed 2026-01-03: UnifiedDocumentProcessor (11-step pipeline), ProcessingContext/ProcessingResult types, BaseStepHandler (Template Method), 11 step implementations (FILE_TYPE_DETECTION→ROUTING_DECISION), UnifiedProcessorFlags (8 feature flags for gradual rollout), LegacyProcessorAdapter for backward compatibility
  15-2-issuer-identification-integration: done  # Completed 2026-01-03: IssuerIdentifierAdapter (封裝 document-issuer.service.ts), IssuerIdentificationStep (Step 4), issuer-identification.ts types (IssuerIdentificationRequest/Result/Options, IdentificationMethod/CompanyStatus/MatchType enums, convertLegacyResult), Parameters<typeof fn> type inference pattern, methodMapping for type conversion, backward compatible with legacy service
  15-3-format-matching-dynamic-config: done  # Completed 2026-01-03: FormatMatchingStep (Step 5), ConfigFetchingStep (Step 6), FormatMatcherAdapter (封裝 document-format.service.ts), ConfigFetcherAdapter (整合 prompt-resolver + field-mapping 配置), format-matching.ts types, dynamic-config.ts types, 三層配置解析 (Format→Company→Global), ResolutionVariableType 轉換
  15-4-continuous-term-learning: done  # Completed 2026-01-03: TermRecordingStep (Step 9), TermRecorderAdapter (整合 hierarchical-term-aggregation.service), term-learning.ts types (DetectedTerm/MatchedTerm/NewTerm/SynonymCandidate, TermStatus/TermSource/TermMatchMethod enums, FreightChargeCategory), Levenshtein similarity 85% threshold, address-like term filtering, flags.enableTermRecording feature flag
  15-5-enhanced-confidence-calculation: done  # Completed 2026-01-03: ConfidenceCalculationStep (Step 10), RoutingDecisionStep (Step 11), ConfidenceCalculatorAdapter (7-dimension weighted: EXTRACTION 25%, ISSUER 15%, FORMAT 15%, CONFIG 10%, HISTORY 15%, FIELD 10%, TERM 10%), RoutingDecisionAdapter (AUTO_APPROVE≥90%, QUICK_REVIEW 70-89%, FULL_REVIEW<70%), ConfigSource加成 (SPECIFIC+10%, COMPANY+5%, FORMAT+3%), ConfidenceLevelEnum (VERY_HIGH/HIGH/MEDIUM/LOW/VERY_LOW), confidence.ts types
  epic-15-retrospective: optional

  # ============================================================
  # Epic 16: 文件格式管理
  # ============================================================
  epic-16: done  # All 8 stories completed 2026-01-14
  16-1-format-list-tab: done  # Completed 2026-01-12: FormatList/FormatCard/FormatFilters components, useCompanyFormats hook, ForwarderDetailView「格式」Tab, document-format types extension (FormatFiltersState, DOCUMENT_TYPE/SUBTYPE_OPTIONS)
  16-2-format-detail-edit: done  # Completed 2026-01-12: FormatDetailView Tabs (basic/terms/files), FormatBasicInfo, FormatForm, FormatTermsTable, FormatFilesTable, useFormatDetail/useFormatFiles hooks, GET/PATCH /api/v1/formats/[id], /api/v1/formats/[id]/files, DocumentFormatDetail type
  16-3-identification-rules-config: done  # Completed 2026-01-12: IdentificationRulesEditor/LogoPatternEditor/KeywordTagInput components, identificationRules Json field in DocumentFormat, Zod validation schema, PATCH API update, FormatDetailView 識別規則 Tab
  16-4-linked-config-panel: done  # Completed 2026-01-12: FormatConfigPanel/LinkedPromptConfig/LinkedMappingConfig/ConfigInheritanceInfo components, GET /api/v1/formats/[id]/configs API, FormatDetailView 專屬配置 Tab
  16-5-identification-rules-prompt-integration: done  # Completed 2026-01-13: FormatIdentificationRule type, identification-rules-prompt-builder.ts, ConfigFetchingStep reads rules, GptEnhancedExtractionStep passes rules, gpt-vision.service.ts injects prompt
  16-6-dynamic-field-mapping: done  # Completed 2026-01-13: source-field.service.ts (標準欄位+動態提取欄位), GET /api/v1/formats/[id]/extracted-fields API, field-mapping.step.ts applyThreeTierMapping (整合 DynamicMappingService), SourceFieldCombobox.tsx (分組顯示+搜尋+自訂欄位)
  16-7-data-template-management: done  # Completed 2026-01-13: DataTemplate Prisma model, data-template.ts types, data-template.ts Zod schema, data-template.service.ts CRUD, /api/v1/data-templates CRUD API, /admin/data-templates UI (列表/新增/編輯), DataTemplateFieldEditor 欄位編輯器, 3 system templates seeded (ERP/費用報表/物流追蹤)
  16-8-manual-format-creation: done  # Completed 2026-01-14: POST /api/v1/formats API endpoint, createDocumentFormatManually service (Prisma transaction), createDocumentFormatSchema Zod validation, useCreateFormat mutation hook, CreateFormatDialog component (進階選項展開), FormatList integration (空狀態+統計資訊旁), auto-create FieldMappingConfig/PromptConfig options, 409 duplicate format handling
  epic-16-retrospective: optional

  # ============================================================
  # Epic 17: 國際化 (i18n)
  # ============================================================
  epic-17: done  # All 5 stories completed 2026-01-17 - i18n internationalization using next-intl
  17-1-i18n-infrastructure-setup: done  # Completed 2026-01-17: next-intl 4.x, i18n config (config.ts/request.ts/routing.ts), routing restructure ([locale]/...), middleware integration (i18n + NextAuth), en/zh-TW/zh-CN locales, messages JSON (common namespace), [locale]/layout.tsx (NextIntlClientProvider), root redirect page
  17-2-core-ui-text-internationalization: done  # Completed 2026-01-17: 10 translation namespaces (common/invoices/review/navigation/dialogs/admin/auth/companies/rules/reports), i18n/request.ts multi-namespace loading, invoices/page.tsx + review/page.tsx + Sidebar.tsx refactored with useTranslations
  17-3-validation-error-internationalization: done  # Completed 2026-01-17: validation.json/errors.json (zh-TW/en/zh-CN), i18n-zod.ts (Zod 4.x locales integration), i18n-api-error.ts (RFC 7807 + Accept-Language), use-localized-zod.ts hook, use-localized-toast.ts hook, COMMON_FIELD_LABELS mapping
  17-4-date-number-currency-formatting: done  # Completed 2026-01-17: i18n-date.ts (date-fns locales integration, DATE_FORMATS), i18n-number.ts (formatNumber/formatPercent/formatCompact/formatInteger/formatDecimal), i18n-currency.ts (7 currencies, CURRENCY_SYMBOLS/NAMES), use-localized-date.ts hook, use-localized-format.ts hook (unified API)
  17-5-language-preference-settings: done  # Completed 2026-01-17: LocaleSwitcher component (TopBar integration), use-locale-preference.ts hook (LocalStorage + DB sync), User.preferredLocale Prisma field, PATCH /api/v1/users/me/locale API, next-auth session/jwt preferredLocale extension, hreflang meta tags in layout.tsx
  epic-17-retrospective: optional

  # ============================================================
  # Epic 18: 本地帳號認證系統
  # ============================================================
  epic-18: done  # All 4 stories completed 2026-01-19 - Local account authentication system
  18-1-user-registration: done  # Completed 2026-01-19: RegisterForm (RHF+Zod), password.ts (bcryptjs salt=12), token.ts (crypto.randomBytes), email.ts (Nodemailer + verification template), POST /api/auth/register, User model extensions (emailVerificationToken/Expires, passwordResetToken/Expires), auth.json i18n (en/zh-TW/zh-CN)
  18-2-local-account-login: done  # Completed 2026-01-19: LoginForm (RHF+Zod), auth.config.ts Credentials Provider (dynamic import, bcrypt verify), auth.ts JWT/signIn callbacks (provider detection, DB user load), login/page.tsx dual UI (Azure AD + local), auth.json i18n updates, error handling (AccountSuspended/Disabled/EmailNotVerified/CredentialsSignin)
  18-3-password-reset: done  # Completed 2026-01-19: forgot-password/reset-password/verify-reset-token APIs, sendPasswordChangedEmail (email.ts), forgot-password/reset-password pages (RHF+Zod, token verification, password strength indicator), auth.json i18n (forgotPassword/resetPassword namespaces)
  18-4-email-verification: done  # Completed 2026-01-19: GET /api/auth/verify-email (token validation, redirect), POST /api/auth/resend-verification (rate limit 5/hr), verify-email/page.tsx (status display, resend form), email.ts (API-based verify URL with locale), LoginForm (verified success, resend link), auth.json i18n (verifyEmail namespace en/zh-TW/zh-CN)
  epic-18-retrospective: optional

  # ============================================================
  # Epic 19: 數據模版匹配與輸出
  # ============================================================
  epic-19: done  # All 8 stories completed 2026-01-23 - Template Matching & Export
  19-1-template-field-mapping-model: done  # Completed 2026-01-22: TemplateFieldMapping model (GLOBAL/COMPANY/FORMAT scope), TemplateFieldMappingRule (DIRECT/FORMULA/LOOKUP/CONCAT/SPLIT/CUSTOM transforms), template-field-mapping.service.ts (CRUD + resolveMapping with 3-tier priority), template-field-mapping.ts types, Zod validation, CRUD APIs
  19-2-template-instance-model: done  # Completed 2026-01-22: TemplateInstance model (DRAFT/PROCESSING/COMPLETED/EXPORTED/ERROR status), TemplateInstanceRow model (rowKey + sourceDocumentIds merge), template-instance.service.ts (instance+row CRUD, validation, statistics), template-instance.ts types, Zod validation, instance/row CRUD APIs
  19-3-template-matching-engine: done  # Completed 2026-01-22: TemplateMatchingEngineService (matchDocuments/previewMatch/validateMapping), Transform module (DIRECT/FORMULA/LOOKUP/CONCAT/SPLIT transforms, TransformExecutor factory), template-matching-engine.ts types, Zod validation, execute/preview/validate APIs
  19-4-template-field-mapping-ui: done  # Completed 2026-01-22: TemplateFieldMappingList (列表頁), TemplateFieldMappingForm (創建/編輯表單), MappingRuleEditor (規則編輯器), SourceFieldSelector/TargetFieldSelector (欄位選擇器), FormulaEditor (公式編輯器+安全解析器), LookupTableEditor (查表編輯器), MappingTestPanel (測試預覽), TransformConfigEditor (轉換配置), standard-fields.ts (50+標準欄位), use-template-field-mappings.ts hooks, templateFieldMapping.json i18n (en/zh-TW/zh-CN)
  19-5-template-instance-ui: done  # Completed 2026-01-22: TemplateInstanceList (列表頁), TemplateInstanceCard (卡片), TemplateInstanceFilters (篩選器), CreateInstanceDialog (創建對話框), TemplateInstanceDetail (詳情頁), InstanceStatsOverview (統計), InstanceRowsTable (數據行表格), RowEditDialog (編輯對話框), RowDetailDrawer (詳情抽屜), BulkActionsMenu (批量操作), use-template-instances.ts hooks, templateInstance.json i18n (en/zh-TW/zh-CN)
  19-6-template-export: done  # Completed 2026-01-23: TemplateExportService (Excel/CSV export, exceljs), exportToExcel/exportToCsv (row filter, field selection, format options), GET /api/v1/template-instances/[id]/export API (xlsx/csv/rowFilter/fields params), ExportDialog (format/row/field selection), ExportFieldSelector (draggable field selection), templateInstance.json i18n export section (en/zh-TW/zh-CN)
  19-7-batch-auto-matching: done  # Completed 2026-01-23: AutoTemplateMatchingService (resolveDefaultTemplate 3-tier priority, autoMatch, batchMatch, unmatch), Document/Company/DocumentFormat.defaultTemplateId relations, POST /api/v1/documents/match (batch), POST /api/v1/documents/[id]/match (single), POST /api/v1/documents/[id]/unmatch, MatchToTemplateDialog, BulkMatchDialog, DefaultTemplateSelector, MatchStatusBadge components, templateInstance.json i18n match/unmatch sections (en/zh-TW/zh-CN)
  19-8-integration-testing: done  # Completed 2026-01-23: 6-step TestWizard (TestDataSelector, TemplateSelector, MappingPreview, MatchExecutor, ResultViewer, ExportTester), mock data generation (3 documents with error case), TestReportGenerator (Markdown format, copy/download), templateMatchingTest.json i18n (en/zh-TW/zh-CN)
  epic-19-retrospective: optional
