# Story 7.10: 月度成本分攤報告

**Status:** done

---

## Story

**As a** 財務人員,
**I want** 生成月度成本分攤報告,
**So that** 可以進行內部成本結算。

---

## Acceptance Criteria

### AC1: 月度報告生成入口

**Given** 財務人員在成本報表頁面
**When** 點擊「生成月度報告」
**Then** 顯示月份選擇對話框

### AC2: 報告內容

**Given** 選擇月份
**When** 點擊「生成」
**Then** 系統生成包含以下內容的報告：
- 各城市處理量統計
- 各城市 AI API 成本明細
- 成本分攤比例
- 與上月對比

### AC3: 多格式匯出

**Given** 報告生成完成
**When** 下載報告
**Then** 支援 Excel 和 PDF 格式
**And** PDF 格式包含圖表和摘要

### AC4: 報告歷史

**Given** 財務人員需要查看歷史報告
**When** 訪問報告歷史頁面
**Then** 顯示已生成的月度報告列表
**And** 可以重新下載歷史報告

### AC5: 自動生成排程

**Given** 系統配置了自動生成
**When** 每月初（可配置日期）
**Then** 自動生成上月的成本分攤報告
**And** 通知相關財務人員

---

## Tasks / Subtasks

- [x] **Task 1: 月度報告數據服務** (AC: #2)
  - [x] 1.1 創建 `MonthlyCostReportService`
  - [x] 1.2 實現各城市處理量統計
  - [x] 1.3 實現 API 成本明細聚合
  - [x] 1.4 計算成本分攤比例
  - [x] 1.5 計算月度對比

- [x] **Task 2: 報告生成 API** (AC: #1, #2)
  - [x] 2.1 創建 `POST /api/reports/monthly-cost/generate` 端點
  - [x] 2.2 驗證月份參數
  - [x] 2.3 觸發報告生成（同步/異步）
  - [x] 2.4 返回報告 ID 和狀態

- [x] **Task 3: Excel 報告生成** (AC: #3)
  - [x] 3.1 創建 Excel 報告模板
  - [x] 3.2 實現多工作表結構（摘要、城市明細、API成本、每日趨勢）
  - [x] 3.3 設置格式和樣式

- [x] **Task 4: PDF 報告生成** (AC: #3)
  - [x] 4.1 創建 PDF 報告模板
  - [x] 4.2 添加執行摘要
  - [x] 4.3 設置頁首頁尾

- [x] **Task 5: 報告歷史管理** (AC: #4)
  - [x] 5.1 創建 `MonthlyReport` 模型
  - [x] 5.2 實現報告歷史 API
  - [x] 5.3 創建報告歷史頁面
  - [x] 5.4 實現報告重新下載

- [ ] **Task 6: 自動生成排程** (AC: #5) - 延後至後續 Sprint
  - [ ] 6.1 創建排程任務配置
  - [ ] 6.2 實現自動生成邏輯
  - [ ] 6.3 實現完成通知
  - [ ] 6.4 處理生成失敗情況

- [x] **Task 7: 報告生成 UI** (AC: #1)
  - [x] 7.1 創建月份選擇對話框 (MonthPicker)
  - [x] 7.2 創建報告生成對話框 (MonthlyReportDialog)
  - [x] 7.3 提供下載按鈕
  - [x] 7.4 處理錯誤狀態

- [x] **Task 8: 類型與 Hooks** (AC: #1-5)
  - [x] 8.1 創建 monthly-report.ts 類型定義
  - [x] 8.2 創建 use-monthly-report.ts React Query hooks

---

## Dev Notes

### 依賴項

- **Story 7.7**: 城市處理數量追蹤
- **Story 7.8**: 城市 AI 成本追蹤
- **Story 7.9**: 城市成本報表

### Architecture Compliance

```prisma
// prisma/schema.prisma - 月度報告模型
model MonthlyReport {
  id            String   @id @default(uuid())
  reportMonth   DateTime @map("report_month") @db.Date  // 報告月份（月初日期）
  reportType    String   @default("COST_ALLOCATION") @map("report_type")
  status        ReportStatus @default(PENDING)
  generatedBy   String?  @map("generated_by")
  isAutoGenerated Boolean @default(false) @map("is_auto_generated")

  // 報告摘要數據
  totalCost     Float?   @map("total_cost")
  totalVolume   Int?     @map("total_volume")
  cityCount     Int?     @map("city_count")
  summaryData   Json?    @map("summary_data")

  // 檔案路徑
  excelPath     String?  @map("excel_path")
  pdfPath       String?  @map("pdf_path")

  // 時間戳
  createdAt     DateTime @default(now()) @map("created_at")
  generatedAt   DateTime? @map("generated_at")
  expiresAt     DateTime? @map("expires_at")

  // 錯誤資訊
  errorMessage  String?  @map("error_message")

  generatedByUser User?  @relation(fields: [generatedBy], references: [id])

  @@unique([reportMonth, reportType])
  @@index([reportMonth])
  @@index([status])
  @@map("monthly_reports")
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}
```

```typescript
// src/types/monthly-report.ts
export interface MonthlyReportData {
  reportMonth: string  // YYYY-MM
  generatedAt: string

  // 總覽
  summary: {
    totalCost: number
    totalVolume: number
    totalAiCost: number
    totalLaborCost: number
    avgCostPerDocument: number
    cityCount: number
    comparedToPreviousMonth: {
      costChange: number
      volumeChange: number
      costPerDocChange: number
    }
  }

  // 各城市明細
  cityBreakdown: {
    cityCode: string
    cityName: string
    regionName?: string
    volume: number
    volumePercentage: number
    aiCost: number
    laborCost: number
    totalCost: number
    costPercentage: number
    costPerDocument: number
    comparedToPreviousMonth: {
      costChange: number
      volumeChange: number
    }
  }[]

  // API 成本明細
  apiCostBreakdown: {
    provider: string
    calls: number
    tokens: { input: number; output: number }
    cost: number
    percentage: number
  }[]

  // 每日趨勢
  dailyTrend: {
    date: string
    volume: number
    cost: number
  }[]
}

export interface MonthlyReportGenerateRequest {
  month: string  // YYYY-MM
  format: ('excel' | 'pdf')[]
  sendNotification?: boolean
}

export interface MonthlyReportRecord {
  id: string
  reportMonth: string
  status: 'PENDING' | 'GENERATING' | 'COMPLETED' | 'FAILED'
  totalCost?: number
  totalVolume?: number
  excelUrl?: string
  pdfUrl?: string
  generatedAt?: string
  generatedBy?: string
  isAutoGenerated: boolean
  errorMessage?: string
}
```

```typescript
// src/services/monthly-cost-report.service.ts
import { prisma } from '@/lib/prisma'
import { uploadToBlob, generateSignedUrl } from '@/lib/azure-blob'
import { cityCostReportService } from './city-cost-report.service'
import { aiCostService } from './ai-cost.service'
import { processingStatsService } from './processing-stats.service'
import { MonthlyReportData, MonthlyReportRecord } from '@/types/monthly-report'
import ExcelJS from 'exceljs'
import PDFDocument from 'pdfkit'

export class MonthlyCostReportService {
  /**
   * 生成月度報告
   */
  async generateReport(
    month: string,  // YYYY-MM
    formats: ('excel' | 'pdf')[],
    generatedBy?: string,
    isAutoGenerated: boolean = false
  ): Promise<MonthlyReportRecord> {
    // 解析月份
    const [year, monthNum] = month.split('-').map(Number)
    const startDate = new Date(year, monthNum - 1, 1)
    const endDate = new Date(year, monthNum, 0, 23, 59, 59, 999)

    // 創建報告記錄
    const report = await prisma.monthlyReport.upsert({
      where: {
        reportMonth_reportType: {
          reportMonth: startDate,
          reportType: 'COST_ALLOCATION'
        }
      },
      create: {
        reportMonth: startDate,
        status: 'GENERATING',
        generatedBy,
        isAutoGenerated
      },
      update: {
        status: 'GENERATING',
        generatedBy,
        isAutoGenerated,
        errorMessage: null
      }
    })

    try {
      // 收集報告數據
      const reportData = await this.collectReportData(startDate, endDate)

      // 生成檔案
      let excelPath: string | undefined
      let pdfPath: string | undefined

      if (formats.includes('excel')) {
        const excelBuffer = await this.generateExcelReport(reportData)
        excelPath = await uploadToBlob(
          excelBuffer,
          `monthly-cost-${month}.xlsx`,
          'reports'
        )
      }

      if (formats.includes('pdf')) {
        const pdfBuffer = await this.generatePdfReport(reportData)
        pdfPath = await uploadToBlob(
          pdfBuffer,
          `monthly-cost-${month}.pdf`,
          'reports'
        )
      }

      // 更新報告記錄
      const expiresAt = new Date()
      expiresAt.setDate(expiresAt.getDate() + 90) // 90 天有效期

      await prisma.monthlyReport.update({
        where: { id: report.id },
        data: {
          status: 'COMPLETED',
          totalCost: reportData.summary.totalCost,
          totalVolume: reportData.summary.totalVolume,
          cityCount: reportData.summary.cityCount,
          summaryData: reportData.summary as any,
          excelPath,
          pdfPath,
          generatedAt: new Date(),
          expiresAt
        }
      })

      return this.toReportRecord(
        await prisma.monthlyReport.findUnique({ where: { id: report.id } })!
      )
    } catch (error) {
      await prisma.monthlyReport.update({
        where: { id: report.id },
        data: {
          status: 'FAILED',
          errorMessage: error instanceof Error ? error.message : 'Unknown error'
        }
      })
      throw error
    }
  }

  /**
   * 收集報告數據
   */
  private async collectReportData(startDate: Date, endDate: Date): Promise<MonthlyReportData> {
    // 獲取所有城市
    const cities = await prisma.city.findMany({
      include: { region: { select: { name: true } } }
    })

    // 並行獲取各項數據
    const [cityStats, apiStats, dailyTrend, prevMonthStats] = await Promise.all([
      this.getCityStats(startDate, endDate),
      this.getApiStats(startDate, endDate),
      this.getDailyTrend(startDate, endDate),
      this.getPreviousMonthStats(startDate)
    ])

    // 計算總覽
    const totalCost = cityStats.reduce((sum, c) => sum + c.totalCost, 0)
    const totalVolume = cityStats.reduce((sum, c) => sum + c.volume, 0)
    const totalAiCost = cityStats.reduce((sum, c) => sum + c.aiCost, 0)
    const totalLaborCost = cityStats.reduce((sum, c) => sum + c.laborCost, 0)

    // 組裝城市明細
    const cityMap = new Map(cities.map(c => [c.code, c]))
    const cityBreakdown = cityStats.map(stat => {
      const city = cityMap.get(stat.cityCode)
      return {
        cityCode: stat.cityCode,
        cityName: city?.name || stat.cityCode,
        regionName: city?.region?.name,
        volume: stat.volume,
        volumePercentage: totalVolume > 0 ? (stat.volume / totalVolume) * 100 : 0,
        aiCost: stat.aiCost,
        laborCost: stat.laborCost,
        totalCost: stat.totalCost,
        costPercentage: totalCost > 0 ? (stat.totalCost / totalCost) * 100 : 0,
        costPerDocument: stat.volume > 0 ? stat.totalCost / stat.volume : 0,
        comparedToPreviousMonth: {
          costChange: 0, // 會在後面計算
          volumeChange: 0
        }
      }
    })

    // 按成本排序
    cityBreakdown.sort((a, b) => b.totalCost - a.totalCost)

    return {
      reportMonth: `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}`,
      generatedAt: new Date().toISOString(),
      summary: {
        totalCost,
        totalVolume,
        totalAiCost,
        totalLaborCost,
        avgCostPerDocument: totalVolume > 0 ? totalCost / totalVolume : 0,
        cityCount: cityBreakdown.length,
        comparedToPreviousMonth: {
          costChange: prevMonthStats.totalCost > 0
            ? ((totalCost - prevMonthStats.totalCost) / prevMonthStats.totalCost) * 100
            : 0,
          volumeChange: prevMonthStats.totalVolume > 0
            ? ((totalVolume - prevMonthStats.totalVolume) / prevMonthStats.totalVolume) * 100
            : 0,
          costPerDocChange: prevMonthStats.avgCostPerDoc > 0
            ? (((totalVolume > 0 ? totalCost / totalVolume : 0) - prevMonthStats.avgCostPerDoc) / prevMonthStats.avgCostPerDoc) * 100
            : 0
        }
      },
      cityBreakdown,
      apiCostBreakdown: apiStats,
      dailyTrend
    }
  }

  private async getCityStats(startDate: Date, endDate: Date) {
    // 實現城市統計查詢
    // ... 省略詳細實現
    return []
  }

  private async getApiStats(startDate: Date, endDate: Date) {
    const stats = await prisma.apiUsageLog.groupBy({
      by: ['provider'],
      where: { createdAt: { gte: startDate, lte: endDate } },
      _sum: { estimatedCost: true, tokensInput: true, tokensOutput: true },
      _count: { id: true }
    })

    const total = stats.reduce((sum, s) => sum + (s._sum.estimatedCost || 0), 0)

    return stats.map(s => ({
      provider: s.provider,
      calls: s._count.id,
      tokens: {
        input: s._sum.tokensInput || 0,
        output: s._sum.tokensOutput || 0
      },
      cost: s._sum.estimatedCost || 0,
      percentage: total > 0 ? ((s._sum.estimatedCost || 0) / total) * 100 : 0
    }))
  }

  private async getDailyTrend(startDate: Date, endDate: Date) {
    // 實現每日趨勢查詢
    return []
  }

  private async getPreviousMonthStats(currentMonthStart: Date) {
    const prevStart = new Date(currentMonthStart)
    prevStart.setMonth(prevStart.getMonth() - 1)
    const prevEnd = new Date(currentMonthStart)
    prevEnd.setDate(prevEnd.getDate() - 1)
    prevEnd.setHours(23, 59, 59, 999)

    // 查詢上月統計
    return { totalCost: 0, totalVolume: 0, avgCostPerDoc: 0 }
  }

  /**
   * 生成 Excel 報告
   */
  private async generateExcelReport(data: MonthlyReportData): Promise<Buffer> {
    const workbook = new ExcelJS.Workbook()
    workbook.creator = 'AI Document Extraction System'
    workbook.created = new Date()

    // 摘要工作表
    const summarySheet = workbook.addWorksheet('摘要')
    this.buildSummarySheet(summarySheet, data)

    // 城市明細工作表
    const citySheet = workbook.addWorksheet('城市明細')
    this.buildCitySheet(citySheet, data)

    // API 成本工作表
    const apiSheet = workbook.addWorksheet('API 成本')
    this.buildApiSheet(apiSheet, data)

    // 每日趨勢工作表
    const trendSheet = workbook.addWorksheet('每日趨勢')
    this.buildTrendSheet(trendSheet, data)

    return Buffer.from(await workbook.xlsx.writeBuffer())
  }

  private buildSummarySheet(sheet: ExcelJS.Worksheet, data: MonthlyReportData) {
    sheet.columns = [
      { header: '指標', key: 'metric', width: 30 },
      { header: '數值', key: 'value', width: 20 },
      { header: '較上月', key: 'change', width: 15 }
    ]

    sheet.addRows([
      { metric: '報告月份', value: data.reportMonth, change: '' },
      { metric: '總成本 (USD)', value: `$${data.summary.totalCost.toFixed(2)}`, change: `${data.summary.comparedToPreviousMonth.costChange.toFixed(1)}%` },
      { metric: '總處理量', value: data.summary.totalVolume.toLocaleString(), change: `${data.summary.comparedToPreviousMonth.volumeChange.toFixed(1)}%` },
      { metric: 'AI 成本', value: `$${data.summary.totalAiCost.toFixed(2)}`, change: '' },
      { metric: '人工成本（估算）', value: `$${data.summary.totalLaborCost.toFixed(2)}`, change: '' },
      { metric: '平均單位成本', value: `$${data.summary.avgCostPerDocument.toFixed(4)}`, change: `${data.summary.comparedToPreviousMonth.costPerDocChange.toFixed(1)}%` },
      { metric: '城市數', value: data.summary.cityCount, change: '' }
    ])

    // 設置樣式
    sheet.getRow(1).font = { bold: true }
    sheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' }
    }
  }

  private buildCitySheet(sheet: ExcelJS.Worksheet, data: MonthlyReportData) {
    sheet.columns = [
      { header: '城市', key: 'cityName', width: 20 },
      { header: '區域', key: 'regionName', width: 15 },
      { header: '處理量', key: 'volume', width: 12 },
      { header: '處理量占比', key: 'volumePct', width: 12 },
      { header: 'AI 成本', key: 'aiCost', width: 12 },
      { header: '人工成本', key: 'laborCost', width: 12 },
      { header: '總成本', key: 'totalCost', width: 12 },
      { header: '成本占比', key: 'costPct', width: 12 },
      { header: '單位成本', key: 'costPerDoc', width: 12 }
    ]

    data.cityBreakdown.forEach(city => {
      sheet.addRow({
        cityName: city.cityName,
        regionName: city.regionName || '',
        volume: city.volume,
        volumePct: `${city.volumePercentage.toFixed(1)}%`,
        aiCost: `$${city.aiCost.toFixed(2)}`,
        laborCost: `$${city.laborCost.toFixed(2)}`,
        totalCost: `$${city.totalCost.toFixed(2)}`,
        costPct: `${city.costPercentage.toFixed(1)}%`,
        costPerDoc: `$${city.costPerDocument.toFixed(4)}`
      })
    })

    sheet.getRow(1).font = { bold: true }
    sheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' }
    }

    // 添加篩選
    sheet.autoFilter = {
      from: { row: 1, column: 1 },
      to: { row: 1, column: 9 }
    }
  }

  private buildApiSheet(sheet: ExcelJS.Worksheet, data: MonthlyReportData) {
    sheet.columns = [
      { header: 'API 供應商', key: 'provider', width: 25 },
      { header: '調用次數', key: 'calls', width: 15 },
      { header: '輸入 Tokens', key: 'tokensInput', width: 15 },
      { header: '輸出 Tokens', key: 'tokensOutput', width: 15 },
      { header: '成本 (USD)', key: 'cost', width: 15 },
      { header: '占比', key: 'percentage', width: 10 }
    ]

    data.apiCostBreakdown.forEach(api => {
      sheet.addRow({
        provider: api.provider,
        calls: api.calls,
        tokensInput: api.tokens.input,
        tokensOutput: api.tokens.output,
        cost: `$${api.cost.toFixed(2)}`,
        percentage: `${api.percentage.toFixed(1)}%`
      })
    })

    sheet.getRow(1).font = { bold: true }
  }

  private buildTrendSheet(sheet: ExcelJS.Worksheet, data: MonthlyReportData) {
    sheet.columns = [
      { header: '日期', key: 'date', width: 15 },
      { header: '處理量', key: 'volume', width: 12 },
      { header: '成本 (USD)', key: 'cost', width: 15 }
    ]

    data.dailyTrend.forEach(day => {
      sheet.addRow({
        date: day.date,
        volume: day.volume,
        cost: `$${day.cost.toFixed(2)}`
      })
    })

    sheet.getRow(1).font = { bold: true }
  }

  /**
   * 生成 PDF 報告
   */
  private async generatePdfReport(data: MonthlyReportData): Promise<Buffer> {
    return new Promise((resolve, reject) => {
      const chunks: Buffer[] = []
      const doc = new PDFDocument({ margin: 50 })

      doc.on('data', chunk => chunks.push(chunk))
      doc.on('end', () => resolve(Buffer.concat(chunks)))
      doc.on('error', reject)

      // 標題
      doc.fontSize(20).text('月度成本分攤報告', { align: 'center' })
      doc.fontSize(14).text(data.reportMonth, { align: 'center' })
      doc.moveDown(2)

      // 摘要
      doc.fontSize(16).text('執行摘要')
      doc.moveDown()
      doc.fontSize(12)
      doc.text(`總成本: $${data.summary.totalCost.toFixed(2)} (較上月 ${data.summary.comparedToPreviousMonth.costChange.toFixed(1)}%)`)
      doc.text(`總處理量: ${data.summary.totalVolume.toLocaleString()} (較上月 ${data.summary.comparedToPreviousMonth.volumeChange.toFixed(1)}%)`)
      doc.text(`平均單位成本: $${data.summary.avgCostPerDocument.toFixed(4)}`)
      doc.text(`城市數: ${data.summary.cityCount}`)
      doc.moveDown(2)

      // 城市成本排名（前 10）
      doc.fontSize(16).text('城市成本排名 (Top 10)')
      doc.moveDown()

      const top10 = data.cityBreakdown.slice(0, 10)
      top10.forEach((city, i) => {
        doc.fontSize(10).text(
          `${i + 1}. ${city.cityName}: $${city.totalCost.toFixed(2)} (${city.costPercentage.toFixed(1)}%)`,
          { indent: 20 }
        )
      })

      // 頁尾
      doc.fontSize(8).text(
        `生成時間: ${new Date().toISOString()}`,
        50,
        doc.page.height - 50,
        { align: 'center' }
      )

      doc.end()
    })
  }

  /**
   * 獲取報告歷史
   */
  async getReportHistory(limit: number = 12): Promise<MonthlyReportRecord[]> {
    const reports = await prisma.monthlyReport.findMany({
      where: { reportType: 'COST_ALLOCATION' },
      orderBy: { reportMonth: 'desc' },
      take: limit
    })

    return reports.map(r => this.toReportRecord(r))
  }

  /**
   * 獲取下載連結
   */
  async getDownloadUrl(reportId: string, format: 'excel' | 'pdf'): Promise<string | null> {
    const report = await prisma.monthlyReport.findUnique({
      where: { id: reportId }
    })

    if (!report || report.status !== 'COMPLETED') return null

    const path = format === 'excel' ? report.excelPath : report.pdfPath
    if (!path) return null

    // 生成簽名 URL（1 小時有效）
    const expiresAt = new Date()
    expiresAt.setHours(expiresAt.getHours() + 1)
    return generateSignedUrl(path, expiresAt)
  }

  private toReportRecord(report: any): MonthlyReportRecord {
    return {
      id: report.id,
      reportMonth: report.reportMonth.toISOString().slice(0, 7),
      status: report.status,
      totalCost: report.totalCost,
      totalVolume: report.totalVolume,
      excelUrl: report.excelPath ? 'available' : undefined,
      pdfUrl: report.pdfPath ? 'available' : undefined,
      generatedAt: report.generatedAt?.toISOString(),
      generatedBy: report.generatedBy,
      isAutoGenerated: report.isAutoGenerated,
      errorMessage: report.errorMessage
    }
  }
}

export const monthlyCostReportService = new MonthlyCostReportService()
```

```typescript
// src/app/api/reports/monthly-cost/generate/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/lib/auth'
import { monthlyCostReportService } from '@/services/monthly-cost-report.service'

export async function POST(request: NextRequest) {
  try {
    const session = await auth()

    // 權限檢查
    if (!session?.user?.permissions?.includes('GENERATE_REPORTS')) {
      return NextResponse.json(
        { success: false, error: 'Permission denied' },
        { status: 403 }
      )
    }

    const { month, format = ['excel', 'pdf'], sendNotification = false } = await request.json()

    // 驗證月份格式
    if (!month || !/^\d{4}-\d{2}$/.test(month)) {
      return NextResponse.json(
        { success: false, error: 'Invalid month format. Use YYYY-MM' },
        { status: 400 }
      )
    }

    // 不能生成未來月份的報告
    const [year, monthNum] = month.split('-').map(Number)
    const now = new Date()
    if (year > now.getFullYear() || (year === now.getFullYear() && monthNum > now.getMonth() + 1)) {
      return NextResponse.json(
        { success: false, error: 'Cannot generate report for future months' },
        { status: 400 }
      )
    }

    const report = await monthlyCostReportService.generateReport(
      month,
      format,
      session.user.id,
      false
    )

    return NextResponse.json({
      success: true,
      data: report
    })
  } catch (error) {
    console.error('Monthly report generation error:', error)
    return NextResponse.json(
      { success: false, error: 'Failed to generate report' },
      { status: 500 }
    )
  }
}
```

```typescript
// src/components/reports/MonthlyReportDialog.tsx
'use client'

import { useState } from 'react'
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { CalendarIcon, Loader2, FileSpreadsheet, FileText } from 'lucide-react'
import { format } from 'date-fns'
import { zhTW } from 'date-fns/locale'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Calendar } from '@/components/ui/calendar'
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover'
import { Checkbox } from '@/components/ui/checkbox'
import { Label } from '@/components/ui/label'
import { useToast } from '@/components/ui/use-toast'

export function MonthlyReportDialog() {
  const [open, setOpen] = useState(false)
  const [selectedDate, setSelectedDate] = useState<Date | undefined>(
    new Date(new Date().setMonth(new Date().getMonth() - 1))
  )
  const [formats, setFormats] = useState<('excel' | 'pdf')[]>(['excel', 'pdf'])
  const { toast } = useToast()
  const queryClient = useQueryClient()

  const generateMutation = useMutation({
    mutationFn: async () => {
      if (!selectedDate) throw new Error('Please select a month')

      const month = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}`

      const response = await fetch('/api/reports/monthly-cost/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ month, format: formats })
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.error || 'Generation failed')
      }

      return response.json()
    },
    onSuccess: () => {
      toast({
        title: '報告生成成功',
        description: '月度成本分攤報告已生成，可在報告歷史中下載。'
      })
      queryClient.invalidateQueries({ queryKey: ['monthly-reports'] })
      setOpen(false)
    },
    onError: (error) => {
      toast({
        title: '生成失敗',
        description: error instanceof Error ? error.message : '請稍後再試',
        variant: 'destructive'
      })
    }
  })

  const toggleFormat = (format: 'excel' | 'pdf') => {
    setFormats(prev =>
      prev.includes(format)
        ? prev.filter(f => f !== format)
        : [...prev, format]
    )
  }

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button>生成月度報告</Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>生成月度成本分攤報告</DialogTitle>
          <DialogDescription>
            選擇月份和匯出格式，系統將生成詳細的成本分攤報告。
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* 月份選擇 */}
          <div className="space-y-2">
            <Label>選擇月份</Label>
            <Popover>
              <PopoverTrigger asChild>
                <Button variant="outline" className="w-full justify-start">
                  <CalendarIcon className="mr-2 h-4 w-4" />
                  {selectedDate
                    ? format(selectedDate, 'yyyy 年 M 月', { locale: zhTW })
                    : '選擇月份'}
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-auto p-0">
                <Calendar
                  mode="single"
                  selected={selectedDate}
                  onSelect={setSelectedDate}
                  locale={zhTW}
                  disabled={(date) => date > new Date()}
                  captionLayout="dropdown-buttons"
                  fromYear={2023}
                  toYear={new Date().getFullYear()}
                />
              </PopoverContent>
            </Popover>
          </div>

          {/* 格式選擇 */}
          <div className="space-y-2">
            <Label>匯出格式</Label>
            <div className="flex gap-4">
              <div className="flex items-center space-x-2">
                <Checkbox
                  id="excel"
                  checked={formats.includes('excel')}
                  onCheckedChange={() => toggleFormat('excel')}
                />
                <label htmlFor="excel" className="flex items-center gap-1 text-sm">
                  <FileSpreadsheet className="h-4 w-4" />
                  Excel
                </label>
              </div>
              <div className="flex items-center space-x-2">
                <Checkbox
                  id="pdf"
                  checked={formats.includes('pdf')}
                  onCheckedChange={() => toggleFormat('pdf')}
                />
                <label htmlFor="pdf" className="flex items-center gap-1 text-sm">
                  <FileText className="h-4 w-4" />
                  PDF
                </label>
              </div>
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => setOpen(false)}>
            取消
          </Button>
          <Button
            onClick={() => generateMutation.mutate()}
            disabled={generateMutation.isPending || !selectedDate || formats.length === 0}
          >
            {generateMutation.isPending && (
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            )}
            生成報告
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

### 排程配置

```typescript
// src/jobs/monthly-report.job.ts
import { CronJob } from 'cron'
import { monthlyCostReportService } from '@/services/monthly-cost-report.service'
import { notificationService } from '@/services/notification.service'

// 每月 3 日凌晨 2 點自動生成上月報告
export const monthlyReportJob = new CronJob(
  '0 2 3 * *',  // 每月 3 日 02:00
  async () => {
    const now = new Date()
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1)
    const month = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`

    try {
      const report = await monthlyCostReportService.generateReport(
        month,
        ['excel', 'pdf'],
        undefined,
        true  // isAutoGenerated
      )

      // 通知財務人員
      await notificationService.notifyFinanceTeam({
        type: 'MONTHLY_REPORT_GENERATED',
        reportId: report.id,
        month
      })
    } catch (error) {
      console.error('Auto monthly report generation failed:', error)
      // 通知管理員
      await notificationService.notifyAdmins({
        type: 'MONTHLY_REPORT_FAILED',
        month,
        error: error instanceof Error ? error.message : 'Unknown error'
      })
    }
  },
  null,
  false,
  'Asia/Taipei'
)
```

### References

- [Source: docs/03-epics/sections/epic-7-reports-dashboard-cost-tracking.md#story-710]
- [Source: docs/01-planning/prd/sections/functional-requirements.md#FR72]

---

## Story Metadata

| 屬性 | 值 |
|------|------|
| Story ID | 7.10 |
| Story Key | 7-10-monthly-cost-allocation-report |
| Epic | Epic 7: 報表儀表板與成本追蹤 |
| FR Coverage | FR72 |
| Dependencies | Story 7.7, Story 7.8, Story 7.9 |

---

*Story created: 2025-12-16*
*Status: done*
*Completed: 2025-12-20*

---

## Implementation Notes

### 已完成的檔案

#### Database
- `prisma/migrations/xxx_add_monthly_report/` - MonthlyReport 模型遷移

#### Types
- `src/types/monthly-report.ts` - 完整類型定義

#### Services
- `src/services/monthly-cost-report.service.ts` - 報告生成服務（Singleton 模式）
  - `generateReport()` - 生成報告
  - `collectReportData()` - 收集月度數據
  - `generateExcelReport()` - Excel 生成（4個工作表）
  - `generatePdfReport()` - PDF 生成（摘要+城市排名）
  - `getReportHistory()` - 歷史列表
  - `getDownloadUrl()` - 簽名下載連結

#### API Routes
- `src/app/api/reports/monthly-cost/route.ts` - GET 歷史列表
- `src/app/api/reports/monthly-cost/generate/route.ts` - POST 生成報告
- `src/app/api/reports/monthly-cost/[id]/download/route.ts` - GET 下載連結

#### Hooks
- `src/hooks/use-monthly-report.ts`
  - `useMonthlyReports()` - 報告歷史
  - `useGenerateMonthlyReport()` - 生成報告 mutation
  - `useDownloadMonthlyReport()` - 下載報告 mutation

#### Components
- `src/components/ui/month-picker.tsx` - 月份選擇器（Popover + Grid）
- `src/components/reports/MonthlyReportDialog.tsx` - 報告生成對話框

#### Pages
- `src/app/(dashboard)/reports/monthly/page.tsx` - 月度報告頁面

### 技術決策

1. **MonthPicker 組件**: 使用 Popover + Button + Grid 實現，支援年份導航和日期限制
2. **權限檢查**: 使用 `hasPermission(session.user, PERMISSIONS.REPORT_VIEW/REPORT_EXPORT)` 模式
3. **Decimal 處理**: 使用 `Number()` 轉換 Prisma Decimal 類型
4. **報告存儲**: Azure Blob Storage + 簽名 URL（1小時有效）

### 延後項目

- **Task 6: 自動生成排程** - 需要 cron job 基礎設施，延後至後續 Sprint
