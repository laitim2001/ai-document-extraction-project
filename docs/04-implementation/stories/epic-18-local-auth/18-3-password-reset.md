# Story 18.3: 忘記密碼與重設

**Status:** done

---

## Story

**As a** 忘記密碼的用戶,
**I want** 透過電子郵件重設我的密碼,
**So that** 我可以重新取得系統存取權限。

---

## Acceptance Criteria

### AC1: 忘記密碼頁面

**Given** 用戶點擊「忘記密碼？」連結
**When** 頁面載入完成
**Then** 顯示忘記密碼表單：
  - 電子郵件輸入欄位
  - 「發送重設連結」按鈕
  - 「返回登入」連結

### AC2: 發送重設郵件

**Given** 用戶輸入有效的註冊電子郵件
**When** 用戶點擊「發送重設連結」
**Then** 系統產生重設 Token（64 字元）
**And** Token 有效期設為 1 小時
**And** 發送包含重設連結的郵件
**And** 顯示「重設連結已發送，請檢查您的信箱」訊息

### AC3: 非註冊郵件處理

**Given** 用戶輸入未註冊的電子郵件
**When** 用戶提交忘記密碼請求
**Then** 系統仍顯示「重設連結已發送」訊息（安全考量）
**And** 實際上不發送郵件
**And** 不洩漏該郵件是否已註冊

### AC4: 重設密碼頁面

**Given** 用戶點擊郵件中的重設連結
**When** Token 有效
**Then** 顯示重設密碼表單：
  - 新密碼輸入欄位
  - 確認新密碼輸入欄位
  - 「重設密碼」按鈕
**And** 顯示密碼要求提示

### AC5: Token 驗證

**Given** 用戶訪問重設密碼頁面
**When** Token 無效或已過期
**Then** 顯示「重設連結已過期或無效」訊息
**And** 提供「重新請求重設連結」選項

### AC6: 密碼重設成功

**Given** 用戶輸入符合要求的新密碼
**When** 用戶提交重設表單
**Then** 系統更新用戶密碼（bcrypt 加密）
**And** 刪除重設 Token
**And** 發送密碼已變更通知郵件
**And** 重導向至登入頁面並顯示成功訊息

### AC7: 速率限制

**Given** 用戶多次請求密碼重設
**When** 超過速率限制（3 次/小時）
**Then** 顯示「請求過於頻繁，請稍後再試」訊息
**And** 暫時阻止該郵件的重設請求

---

## Tasks / Subtasks

- [x] **Task 1: 資料庫 Schema 確認** (AC: #2)
  - [x] 1.1 確認 User 模型有 passwordResetToken 欄位
  - [x] 1.2 確認 User 模型有 passwordResetExpires 欄位
  - [x] 1.3 執行 Prisma 遷移（如需要）

- [x] **Task 2: 忘記密碼 API** (AC: #2, #3, #7)
  - [x] 2.1 建立 `POST /api/auth/forgot-password` 端點
  - [x] 2.2 實現電子郵件查詢邏輯
  - [x] 2.3 實現 Token 產生和存儲
  - [x] 2.4 實現速率限制檢查
  - [x] 2.5 整合郵件發送服務

- [x] **Task 3: 重設密碼 API** (AC: #4, #5, #6)
  - [x] 3.1 建立 `POST /api/auth/reset-password` 端點
  - [x] 3.2 實現 Token 驗證邏輯
  - [x] 3.3 實現密碼更新邏輯
  - [x] 3.4 實現 Token 失效邏輯
  - [x] 3.5 發送密碼變更通知郵件

- [x] **Task 4: Token 驗證 API** (AC: #5)
  - [x] 4.1 建立 `GET /api/auth/verify-reset-token` 端點
  - [x] 4.2 實現 Token 有效性檢查

- [x] **Task 5: 郵件模板** (AC: #2, #6)
  - [x] 5.1 建立密碼重設郵件 HTML 模板
  - [x] 5.2 建立密碼變更通知郵件模板
  - [x] 5.3 實現郵件發送函數

- [x] **Task 6: 忘記密碼頁面** (AC: #1)
  - [x] 6.1 建立 `src/app/[locale]/(auth)/auth/forgot-password/page.tsx`
  - [x] 6.2 實現忘記密碼表單
  - [x] 6.3 實現載入狀態和成功訊息

- [x] **Task 7: 重設密碼頁面** (AC: #4, #5)
  - [x] 7.1 建立 `src/app/[locale]/(auth)/auth/reset-password/page.tsx`
  - [x] 7.2 實現 Token 驗證和頁面載入
  - [x] 7.3 實現重設密碼表單
  - [x] 7.4 實現密碼強度驗證
  - [x] 7.5 實現 Token 無效處理

- [x] **Task 8: 翻譯文件更新** (AC: #1-6)
  - [x] 8.1 更新 `messages/*/auth.json` 密碼重設相關翻譯

- [x] **Task 9: 驗證與測試** (AC: #1-7)
  - [x] 9.1 測試忘記密碼流程
  - [x] 9.2 測試重設郵件發送
  - [x] 9.3 測試 Token 驗證
  - [x] 9.4 測試密碼重設成功
  - [x] 9.5 測試 Token 過期處理
  - [x] 9.6 測試速率限制

---

## Dev Notes

### 安全考量

1. **不洩漏註冊狀態**：無論郵件是否註冊，都顯示相同的成功訊息
2. **Token 單次使用**：重設後立即刪除 Token
3. **短期有效**：Token 僅 1 小時有效
4. **速率限制**：防止暴力攻擊和郵件轟炸
5. **密碼變更通知**：讓用戶知道密碼已被更改

### API 端點設計

```
POST /api/auth/forgot-password
  Body: { email: string }
  Response: { message: string }

GET /api/auth/verify-reset-token?token=xxx
  Response: { valid: boolean, email?: string }

POST /api/auth/reset-password
  Body: { token: string, password: string, confirmPassword: string }
  Response: { message: string }
```

### 郵件模板設計

```html
<!-- 密碼重設郵件 -->
<h1>重設您的密碼</h1>
<p>親愛的 {{name}}，</p>
<p>我們收到了重設您帳號密碼的請求。</p>
<p>請點擊以下連結重設密碼（有效期 1 小時）：</p>
<a href="{{resetUrl}}">重設密碼</a>
<p>如果您沒有請求重設密碼，請忽略此郵件。</p>
```

### Testing Requirements

| 驗證項目 | 測試方法 | 預期結果 |
|---------|---------|---------|
| 忘記密碼頁面 | 訪問 /auth/forgot-password | 顯示表單 |
| 發送重設郵件 | 輸入已註冊郵件 | 發送郵件並顯示成功 |
| 非註冊郵件 | 輸入未註冊郵件 | 顯示相同成功訊息 |
| Token 驗證 | 使用有效 Token | 顯示重設表單 |
| Token 過期 | 使用過期 Token | 顯示錯誤訊息 |
| 密碼重設 | 提交新密碼 | 更新密碼並重導向 |
| 速率限制 | 多次請求重設 | 顯示頻繁請求訊息 |

---

## Story Metadata

| 屬性 | 值 |
|------|------|
| Story ID | 18.3 |
| Story Key | 18-3-password-reset |
| Epic | Epic 18: 本地帳號認證系統 |
| Estimated Effort | 1 天 |
| Dependencies | Story 18-1, Story 18-2 |
| Blocking | 無 |

---

*Story created: 2026-01-19*
*Status: ready-for-dev*
*Generated by: Claude AI Assistant*
