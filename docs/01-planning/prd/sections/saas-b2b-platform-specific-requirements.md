# SaaS B2B Platform Specific Requirements

## Project-Type Overview

本系統是一個**企業內部 SaaS B2B 平台**，服務於公司 APAC 地區 11 個城市的辦公室。雖然是內部工具，但採用 SaaS 架構模式以支援多城市部署、權限管理和未來擴展。

**關鍵特性：**
- 多城市部署，數據嚴格隔離
- 靈活的角色權限管理（系統內管理 + 自定義角色）
- 全局共享規則，降低維護成本
- 使用量追蹤支援成本分攤
- 對外 API 支援系統整合

## Multi-City Data Architecture（多城市數據架構）

### 數據隔離模型

```
┌─────────────────────────────────────────────────────────────────┐
│ 多城市數據隔離架構                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    全局共享層                            │    │
│  │  • Universal Mapping Rules                               │    │
│  │  • Forwarder Profiles                                    │    │
│  │  • System Configuration                                  │    │
│  │  • AI Learning Rules（經審核後）                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                      │
│         ┌─────────────────┼─────────────────┐                   │
│         ↓                 ↓                 ↓                   │
│  ┌──────────┐      ┌──────────┐      ┌──────────┐              │
│  │  香港    │      │  新加坡  │      │  上海    │  ...         │
│  │  City    │      │  City    │      │  City    │              │
│  │  ────    │      │  ────    │      │  ────    │              │
│  │ 發票數據 │      │ 發票數據 │      │ 發票數據 │              │
│  │ 處理記錄 │      │ 處理記錄 │      │ 處理記錄 │              │
│  │ 審計日誌 │      │ 審計日誌 │      │ 審計日誌 │              │
│  │ 用戶活動 │      │ 用戶活動 │      │ 用戶活動 │              │
│  └──────────┘      └──────────┘      └──────────┘              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 數據隔離原則

| 數據類型 | 隔離級別 | 說明 |
|---------|---------|------|
| **發票數據** | 城市級嚴格隔離 | 各城市僅能訪問本城市數據 |
| **處理記錄** | 城市級嚴格隔離 | 包含處理歷史和修正記錄 |
| **審計日誌** | 城市級嚴格隔離 | 符合本地審計要求 |
| **用戶數據** | 城市級 + 全局角色 | 用戶歸屬城市，但可有跨城市權限 |
| **Mapping Rules** | 全局共享 | 所有城市使用相同規則庫 |
| **Forwarder Profiles** | 全局共享 | 統一的 Forwarder 配置 |
| **系統配置** | 全局共享 | 統一的系統設定 |

### 跨城市查詢機制

| 角色類型 | 訪問範圍 | 實現方式 |
|---------|---------|---------|
| **城市用戶** | 僅本城市 | 預設權限，無需配置 |
| **區域管理者** | 指定多城市 | 明確授權城市列表 |
| **全局管理者** | 所有城市 | 最高權限，需審批 |

## RBAC Permission Matrix（角色權限矩陣）

### 權限管理架構

```
┌─────────────────────────────────────────────────────────────────┐
│ 權限管理架構                                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────┐                                                │
│  │  Azure AD   │ ← 身份認證（SSO 登入）                         │
│  └──────┬──────┘                                                │
│         ↓                                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              系統內權限管理                               │    │
│  │  ┌───────────────┐  ┌───────────────┐                   │    │
│  │  │  角色定義     │  │  權限分配     │                   │    │
│  │  │  (可自定義)   │  │  (用戶↔角色)  │                   │    │
│  │  └───────────────┘  └───────────────┘                   │    │
│  │  ┌───────────────┐  ┌───────────────┐                   │    │
│  │  │  城市歸屬     │  │  功能權限     │                   │    │
│  │  │  (數據範圍)   │  │  (操作範圍)   │                   │    │
│  │  └───────────────┘  └───────────────┘                   │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 預設角色定義

| 角色 | 數據範圍 | 核心權限 | 可自定義 |
|------|---------|---------|---------|
| **數據處理員** | 本城市 | 處理發票、修正數據、提交審核 | ✅ |
| **Super User** | 本城市 | 處理例外、維護規則、審核學習規則 | ✅ |
| **城市經理** | 本城市 | 查看報表、匯出數據、用戶管理 | ✅ |
| **區域經理** | 指定多城市 | 跨城市報表、區域分析 | ✅ |
| **n8n 管理員** | 全局 | 工作流監控、API 管理 | ✅ |
| **財務人員** | 本城市 | 費用核對、財務報表 | ✅ |
| **審計人員** | 本城市/區域 | 唯讀、審計追溯 | ✅ |
| **系統管理員** | 全局 | 用戶管理、系統配置、角色定義 | ❌ |

### 權限矩陣詳細

| 功能模組 | 數據處理員 | Super User | 城市經理 | 區域經理 | 系統管理員 |
|---------|-----------|------------|---------|---------|-----------|
| **發票處理** | ✅ CRUD | ✅ CRUD | ❌ | ❌ | ❌ |
| **數據審核** | ✅ 提交 | ✅ 審核 | ❌ | ❌ | ❌ |
| **規則管理** | ❌ | ✅ 建議+審核 | ❌ | ❌ | ✅ 全局管理 |
| **報表查看** | ✅ 基本 | ✅ 進階 | ✅ 完整 | ✅ 跨城市 | ✅ 全局 |
| **數據匯出** | ❌ | ✅ 本城市 | ✅ 本城市 | ✅ 跨城市 | ✅ 全局 |
| **用戶管理** | ❌ | ❌ | ✅ 本城市 | ❌ | ✅ 全局 |
| **系統配置** | ❌ | ❌ | ❌ | ❌ | ✅ |
| **審計日誌** | ❌ | ✅ 唯讀 | ✅ 唯讀 | ✅ 唯讀 | ✅ 完整 |

### 自定義角色功能

| 功能 | 說明 |
|------|------|
| **角色複製** | 基於現有角色創建新角色 |
| **權限組合** | 自由組合功能權限 |
| **城市範圍** | 指定可訪問的城市列表 |
| **時效限制** | 可設定角色有效期（如：臨時審計） |
| **審批流程** | 高權限角色需要審批 |

## Usage Tracking & Cost Allocation（使用量追蹤與成本分攤）

### 追蹤指標

| 指標類型 | 追蹤項目 | 分攤基礎 |
|---------|---------|---------|
| **處理量** | 發票處理數量 | 按城市統計 |
| **AI API 調用** | Azure DI + OpenAI 調用次數 | 按城市統計 |
| **存儲使用** | 文件存儲容量 | 按城市統計 |
| **用戶數** | 活躍用戶數量 | 按城市統計 |

### 成本分攤模型

```
┌─────────────────────────────────────────────────────────────────┐
│ 月度成本分攤計算                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  總成本 = 基礎設施成本 + AI API 成本 + 存儲成本                   │
│                                                                  │
│  城市分攤 = (城市處理量 / 總處理量) × 總成本                      │
│                                                                  │
│  報表輸出：                                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 城市    │ 處理量  │ 佔比   │ 分攤成本                    │    │
│  │ 香港    │ 15,000  │ 30%    │ HKD 7,500                   │    │
│  │ 新加坡  │ 12,000  │ 24%    │ HKD 6,000                   │    │
│  │ 上海    │ 10,000  │ 20%    │ HKD 5,000                   │    │
│  │ ...     │ ...     │ ...    │ ...                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 成本報表功能

| 報表類型 | 頻率 | 受眾 |
|---------|------|------|
| **城市月報** | 每月 | 城市經理 |
| **區域匯總** | 每月 | 區域經理 |
| **全局總覽** | 每月 | 財務 + 系統管理員 |
| **成本趨勢** | 每季 | 管理層 |

## Integration Architecture（整合架構）

### 已確認的整合

| 整合對象 | 整合類型 | 方向 | 優先級 | 階段 |
|---------|---------|------|--------|------|
| **Azure AD** | 身份認證 | Inbound | 高 | MVP 1.0 |
| **SharePoint** | 文件來源 | Inbound | 高 | MVP 1.0 |
| **Outlook** | 郵件附件 | Inbound | 高 | MVP 1.0 |
| **n8n** | 工作流引擎 | Bidirectional | 高 | 核心 |
| **Azure Document Intelligence** | OCR 服務 | Outbound | 高 | 核心 |
| **Azure OpenAI** | AI 服務 | Outbound | 高 | 核心 |
| **Azure Blob Storage** | 文件存儲 | Bidirectional | 高 | 核心 |
| **PostgreSQL** | 運營數據 | Bidirectional | 高 | 核心 |
| **Snowflake** | 數據倉庫 | Outbound | 中 | Post-MVP |

### 對外 API 設計

本系統將提供 RESTful API 供外部系統整合：

| API 類別 | 端點範例 | 用途 |
|---------|---------|------|
| **文件提交** | POST /api/v1/invoices | 外部系統提交發票 |
| **狀態查詢** | GET /api/v1/invoices/{id}/status | 查詢處理狀態 |
| **結果獲取** | GET /api/v1/invoices/{id}/result | 獲取提取結果 |
| **批量查詢** | GET /api/v1/invoices?filter=... | 批量查詢發票 |
| **報表數據** | GET /api/v1/reports/... | 獲取報表數據 |
| **Webhook 註冊** | POST /api/v1/webhooks | 註冊回調通知 |

### API 安全機制

| 安全機制 | 實現方式 |
|---------|---------|
| **認證** | Azure AD OAuth 2.0 / API Key |
| **授權** | 基於角色的 API 權限 |
| **Rate Limiting** | 每分鐘 100 請求/客戶端 |
| **審計** | 所有 API 調用記錄日誌 |
| **版本控制** | URL 版本號（/api/v1/...） |

## Compliance & Security Requirements（合規與安全需求）

### 數據保護

| 項目 | 要求 | 實現方式 |
|------|------|---------|
| **數據加密（靜態）** | Azure 預設處理 | Azure Storage Service Encryption |
| **數據加密（傳輸）** | Azure 預設處理 | TLS 1.2+ |
| **數據保留** | 7 年 | 自動歸檔策略 |
| **數據刪除** | 依法規要求 | 安全刪除流程 |

### 審計與追溯

| 項目 | 要求 |
|------|------|
| **操作日誌** | 記錄所有用戶操作 |
| **數據變更日誌** | 記錄所有數據修改（who, when, what） |
| **API 調用日誌** | 記錄所有 API 請求 |
| **登入日誌** | 記錄所有登入/登出事件 |
| **日誌保留** | 與數據保留期一致（7 年） |
| **日誌不可篡改** | 獨立存儲，唯讀訪問 |

### 訪問控制

| 項目 | 要求 |
|------|------|
| **身份認證** | Azure AD SSO |
| **會話管理** | 8 小時自動登出 |
| **失敗鎖定** | 5 次失敗後鎖定 30 分鐘 |
| **密碼策略** | 由 Azure AD 統一管理 |

## Technical Architecture Considerations

### 多城市部署選項

| 選項 | 描述 | 優勢 | 挑戰 |
|------|------|------|------|
| **單一實例 + 數據隔離** | 一個應用實例，邏輯隔離數據 | 維護簡單、成本低 | 需要完善的隔離邏輯 |
| **多實例部署** | 每城市獨立實例 | 完全隔離、本地化 | 維護複雜、成本高 |
| **混合模式** | 核心服務共享 + 數據層隔離 | 平衡成本和隔離 | 架構較複雜 |

**建議採用：單一實例 + 數據隔離**（MVP 階段）
- 所有城市共用同一應用實例
- 通過 city_id 實現數據邏輯隔離
- 全局規則庫共享
- 未來可按需遷移到混合模式

### 數據庫設計原則

```sql
-- 所有城市數據表都包含 city_id
CREATE TABLE invoices (
    id UUID PRIMARY KEY,
    city_id VARCHAR(10) NOT NULL,  -- 'HK', 'SG', 'SH', etc.
    ...
    CONSTRAINT fk_city FOREIGN KEY (city_id) REFERENCES cities(id)
);

-- 全局共享表不包含 city_id
CREATE TABLE mapping_rules (
    id UUID PRIMARY KEY,
    rule_type VARCHAR(50),  -- 'universal', 'forwarder_specific', 'learned'
    ...
);

-- Row Level Security (RLS) 實現數據隔離
CREATE POLICY city_isolation ON invoices
    USING (city_id = current_setting('app.current_city'));
```

## Implementation Considerations

### MVP 階段優先級

| 功能 | MVP 0.5 | MVP 1.0 | Post-MVP |
|------|---------|---------|----------|
| 單城市數據處理 | ✅ | ✅ | ✅ |
| 多城市數據隔離 | ❌ | ✅ | ✅ |
| 預設角色權限 | ✅ | ✅ | ✅ |
| 自定義角色 | ❌ | ❌ | ✅ |
| Azure AD SSO | ❌ | ✅ | ✅ |
| 使用量追蹤 | ❌ | ✅ | ✅ |
| 成本分攤報表 | ❌ | ❌ | ✅ |
| 對外 API | ❌ | 基本 | 完整 |

### 關鍵技術決策

| 決策項目 | 選擇 | 原因 |
|---------|------|------|
| **多租戶實現** | 單一實例 + RLS | 維護簡單，成本效益高 |
| **權限管理** | 系統內管理 | 靈活支援自定義角色 |
| **API 版本控制** | URL 版本號 | 簡單直觀，易於管理 |
| **數據隔離** | PostgreSQL RLS | 數據庫層面強制隔離 |

---
